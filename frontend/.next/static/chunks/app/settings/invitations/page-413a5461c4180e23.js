(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[5728],{3695:function(e,s,a){Promise.resolve().then(a.bind(a,14322))},14322:function(e,s,a){"use strict";a.r(s),a.d(s,{default:function(){return x}});var t=a(3827),n=a(64090),r=a(67945),i=a(51055),c=a(20003),l=a(96770),o=a(58222),d=a(56732),u=a(929),m=a(47907);function x(){let{data:e,isLoading:s,refetch:a}=(0,c.X$)(),{showToast:x}=(0,l.useToast)(),[f,h]=(0,n.useState)(!1),y=(0,m.useRouter)(),j=async e=>{h(!0);try{await (0,o.Io)("/families/invitations/".concat(e,"/accept"),{method:"POST"}),x("已成功加入家庭","success"),a(),y.push("/settings/family")}catch(e){x(e.message||"接受邀请失败","error")}finally{h(!1)}},g=async e=>{h(!0);try{await (0,o.Io)("/families/invitations/".concat(e,"/reject"),{method:"POST"}),x("已拒绝邀请","success"),a()}catch(e){x(e.message||"拒绝邀请失败","error")}finally{h(!1)}};return s?(0,t.jsx)("div",{className:"max-w-6xl mx-auto",children:(0,t.jsx)(u.Z,{type:"table"})}):(0,t.jsx)("div",{className:"space-y-8 max-w-6xl mx-auto",children:(0,t.jsx)(r.w,{className:"shadow-sm hover:shadow-md transition-shadow duration-200",children:(0,t.jsxs)(i.G,{className:"p-6",children:[(0,t.jsx)("div",{className:"flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6",children:(0,t.jsxs)("div",{children:[(0,t.jsx)("h2",{className:"text-2xl font-bold text-primary",children:"我的邀请"}),(0,t.jsx)("p",{className:"text-sm text-default-500 mt-1",children:"管理您收到的家庭邀请"})]})}),(0,t.jsx)(d.Z,{invitations:e||[],type:"received",onAccept:j,onReject:g})]})})})}},56732:function(e,s,a){"use strict";a.d(s,{Z:function(){return p}});var t=a(3827),n=a(64090),r=a(49977),i=a(96840),c=a(59584),l=a(10732),o=a(67945),d=a(51055),u=a(50535),m=a(75129),x=a(63053),f=a(77058),h=a(36685),y=a(92339),j=a(67474),g=a(72688),v=a(24424),N=a(62707),w=a(96770);function p(e){let{invitations:s,type:a,onAccept:p,onReject:b,onDelete:z}=e,{showToast:_}=(0,w.useToast)(),[I,T]=(0,n.useState)(null),k=e=>{let s="".concat(window.location.origin,"/invite/").concat(e);navigator.clipboard.writeText(s).then(()=>{_("邀请链接已复制到剪贴板","success")}).catch(()=>{_("复制失败，请手动复制","error")})},S=e=>new Date(e).toLocaleString(),q=e=>new Date(e)<new Date,E=e=>{let s=new Date,a=new Date(e).getTime()-s.getTime();if(a<=0)return"已过期";let t=Math.floor(a/864e5),n=Math.floor(a%864e5/36e5);return t>0?"".concat(t,"天").concat(n,"小时"):"".concat(n,"小时")},F=e=>{let{status:s,expires_at:a,max_uses:n,current_uses:l}=e;if("pending"===s&&q(a)||"expired"===s)return(0,t.jsx)(r.z,{color:"default",variant:"flat",size:"sm",children:"已过期"});switch(s){case"pending":if(n&&n>1){let e=n-(l||0);return(0,t.jsxs)("div",{className:"flex items-center gap-2",children:[(0,t.jsx)(r.z,{color:"warning",variant:"flat",size:"sm",children:"待处理"}),(0,t.jsx)(i.O,{content:"".concat(e,"/").concat(n),color:"primary",size:"sm",children:(0,t.jsx)(c.e,{content:"最多可使用".concat(n,"次，已使用").concat(l||0,"次，剩余").concat(e,"次"),children:(0,t.jsx)(j.Z,{className:"h-4 w-4 text-primary cursor-help"})})})]})}return(0,t.jsx)(r.z,{color:"warning",variant:"flat",size:"sm",children:"待处理"});case"accepted":if(n&&n>1){let e=n-(l||0);if(e>0)return(0,t.jsxs)("div",{className:"flex items-center gap-2",children:[(0,t.jsx)(r.z,{color:"success",variant:"flat",size:"sm",children:"已接受"}),(0,t.jsx)(i.O,{content:"".concat(e,"/").concat(n),color:"primary",size:"sm",children:(0,t.jsx)(c.e,{content:"最多可使用".concat(n,"次，已使用").concat(l||0,"次，还可使用").concat(e,"次"),children:(0,t.jsx)(j.Z,{className:"h-4 w-4 text-primary cursor-help"})})})]});return(0,t.jsxs)("div",{className:"flex items-center gap-2",children:[(0,t.jsx)(r.z,{color:"success",variant:"flat",size:"sm",children:"已接受"}),(0,t.jsx)(r.z,{color:"default",variant:"flat",size:"sm",children:"已用完"})]})}return(0,t.jsx)(r.z,{color:"success",variant:"flat",size:"sm",children:"已接受"});case"rejected":if(n&&n>1){let e=n-(l||0);if(e>0)return(0,t.jsxs)("div",{className:"flex items-center gap-2",children:[(0,t.jsx)(r.z,{color:"danger",variant:"flat",size:"sm",children:"已拒绝"}),(0,t.jsx)(i.O,{content:"".concat(e,"/").concat(n),color:"primary",size:"sm",children:(0,t.jsx)(c.e,{content:"最多可使用".concat(n,"次，已使用").concat(l||0,"次，还可使用").concat(e,"次"),children:(0,t.jsx)(j.Z,{className:"h-4 w-4 text-primary cursor-help"})})})]});return(0,t.jsxs)("div",{className:"flex items-center gap-2",children:[(0,t.jsx)(r.z,{color:"danger",variant:"flat",size:"sm",children:"已拒绝"}),(0,t.jsx)(r.z,{color:"default",variant:"flat",size:"sm",children:"已用完"})]})}return(0,t.jsx)(r.z,{color:"danger",variant:"flat",size:"sm",children:"已拒绝"});default:return null}},D=async(e,s)=>{if(p){T(s);try{await p(e)}finally{T(null)}}},O=async(e,s)=>{if(b){T(s);try{await b(e)}finally{T(null)}}},K=async e=>{if(z&&confirm("确定要删除此邀请吗？")){T(e);try{await z(e)}finally{T(null)}}},L=(0,n.useMemo)(()=>"sent"===a?[{key:"recipient",label:"接收者"},{key:"role",label:"角色"},{key:"status",label:"状态"},{key:"usage",label:"使用次数"},{key:"created_at",label:"创建时间"},{key:"expires_at",label:"有效期"},{key:"actions",label:"操作"}]:[{key:"family",label:"家庭"},{key:"creator",label:"邀请人"},{key:"role",label:"角色"},{key:"expires_at",label:"有效期"},{key:"actions",label:"操作"}],[a]),X=(e,s)=>{switch(console.log("渲染单元格: ".concat(s),e),s){case"recipient":return(0,t.jsx)("div",{className:"font-medium",children:e.is_generic||!e.email?(0,t.jsx)(r.z,{color:"secondary",variant:"flat",size:"sm",children:"通用邀请"}):e.email.replace(/(.{2})(.*)(@.*)/,"$1****$3")});case"family":return(0,t.jsxs)("div",{className:"font-medium",children:[e.family_name,e.is_generic&&(0,t.jsx)(r.z,{color:"secondary",variant:"flat",size:"sm",className:"ml-2",children:"通用邀请"})]});case"creator":return(0,t.jsxs)("div",{className:"text-default-500",children:[e.creator_name,e.max_uses&&e.max_uses>1&&(0,t.jsxs)("div",{className:"text-xs mt-1",children:["可使用",e.max_uses,"次，已使用",e.current_uses||0,"次"]})]});case"role":return(0,t.jsx)(r.z,{color:"admin"===e.role?"primary":"default",variant:"flat",size:"sm",children:"admin"===e.role?"管理员":"成员"});case"status":return F(e);case"usage":console.log("渲染使用次数:",e.max_uses,e.current_uses);let n=e.max_uses||1,o=e.current_uses||0,d=n-o;return(0,t.jsxs)("div",{className:"flex items-center gap-2",children:[(0,t.jsxs)("div",{className:"text-default-500 text-sm",children:[o,"/",n]}),n>1&&(0,t.jsx)(c.e,{content:"最多可使用".concat(n,"次，已使用").concat(o,"次，剩余").concat(d,"次"),children:(0,t.jsx)(i.O,{content:"".concat(d),color:"primary",size:"sm",children:(0,t.jsx)(j.Z,{className:"h-4 w-4 text-default-400 cursor-help"})})})]});case"created_at":return(0,t.jsx)("div",{className:"text-default-500 text-sm",children:S(e.created_at)});case"expires_at":return(0,t.jsxs)("div",{className:"text-default-500 text-sm",children:[(0,t.jsx)("div",{children:S(e.expires_at)}),(0,t.jsx)("div",{className:"text-xs mt-1",children:"pending"===e.status?"剩余: ".concat(E(e.expires_at)):""})]});case"actions":if("sent"===a)return(0,t.jsxs)("div",{className:"flex items-center gap-2",children:["pending"===e.status&&!q(e.expires_at)&&(0,t.jsx)(c.e,{content:"复制邀请链接",children:(0,t.jsx)(l.A,{isIconOnly:!0,size:"sm",variant:"light",onPress:()=>k(e.token),children:(0,t.jsx)(g.Z,{className:"h-4 w-4"})})}),(e.is_generic||!e.email)&&!q(e.expires_at)&&"pending"!==e.status&&(0,t.jsx)(c.e,{content:"复制邀请链接",children:(0,t.jsx)(l.A,{isIconOnly:!0,size:"sm",variant:"light",onPress:()=>k(e.token),children:(0,t.jsx)(g.Z,{className:"h-4 w-4"})})}),z&&(0,t.jsx)(c.e,{content:"删除邀请",children:(0,t.jsx)(l.A,{isIconOnly:!0,size:"sm",color:"danger",variant:"light",onPress:()=>K(e.id),isDisabled:I===e.id,children:(0,t.jsx)(v.Z,{className:"h-4 w-4"})})})]});return(0,t.jsx)("div",{className:"flex items-center gap-2",children:"pending"===e.status&&!q(e.expires_at)&&(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(l.A,{size:"sm",color:"danger",variant:"flat",onPress:()=>O(e.token,e.id),isDisabled:I===e.id,children:"拒绝"}),(0,t.jsx)(l.A,{size:"sm",color:"primary",onPress:()=>D(e.token,e.id),isDisabled:I===e.id,isLoading:I===e.id,children:"接受"})]})});default:return null}};return 0===s.length?(0,t.jsx)(o.w,{children:(0,t.jsxs)(d.G,{className:"py-8 text-center",children:[(0,t.jsx)("div",{className:"text-default-400 mb-2",children:(0,t.jsx)(N.Z,{className:"h-12 w-12 mx-auto"})}),(0,t.jsx)("p",{className:"text-default-600",children:"sent"===a?"暂无已发送的邀请":"暂无收到的邀请"})]})}):(0,t.jsx)("div",{className:"overflow-x-auto",children:(0,t.jsxs)(u.b,{"aria-label":"sent"===a?"已发送的邀请":"收到的邀请",classNames:{base:"min-w-full",table:"min-w-full",thead:"bg-default-50",th:"text-default-700 font-semibold",tr:"hover:bg-default-50 transition-colors border-b border-default-100"},children:[(0,t.jsx)(m.J,{columns:L,children:e=>(0,t.jsx)(x.j,{className:"text-sm",children:e.label},e.key)}),(0,t.jsx)(f.y,{items:s,emptyContent:"暂无邀请",children:e=>(console.log("渲染行:",e),(0,t.jsx)(h.g,{className:"h-14",children:s=>(console.log("渲染列:",s.toString()),(0,t.jsx)(y.X,{children:X(e,s.toString())}))},e.id))})]})})}},929:function(e,s,a){"use strict";a.d(s,{Z:function(){return c}});var t=a(3827),n=a(67945),r=a(51055),i=a(63983);function c(e){let{type:s="transaction",className:a=""}=e;return"statistics"===s?(0,t.jsx)("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[1,2,3].map(e=>(0,t.jsx)(n.w,{className:"w-full",children:(0,t.jsxs)(r.G,{className:"space-y-3",children:[(0,t.jsx)(i.X,{className:"rounded-lg",children:(0,t.jsx)("div",{className:"h-3 w-3/4 rounded-lg bg-default-200"})}),(0,t.jsx)(i.X,{className:"rounded-lg",children:(0,t.jsx)("div",{className:"h-6 w-2/3 rounded-lg bg-default-200"})})]})},e))}):"category"===s?(0,t.jsx)(n.w,{className:"w-full",children:(0,t.jsxs)(r.G,{className:"space-y-4",children:[(0,t.jsxs)("div",{className:"flex justify-between items-center",children:[(0,t.jsx)(i.X,{className:"rounded-lg",children:(0,t.jsx)("div",{className:"h-6 w-32 rounded-lg bg-default-200"})}),(0,t.jsx)(i.X,{className:"rounded-lg",children:(0,t.jsx)("div",{className:"h-8 w-48 rounded-lg bg-default-200"})})]}),(0,t.jsx)(i.X,{className:"rounded-lg",children:(0,t.jsx)("div",{className:"h-[300px] w-full rounded-lg bg-default-200"})}),(0,t.jsx)("div",{className:"grid grid-cols-2 md:grid-cols-3 gap-4",children:[1,2,3,4,5,6].map(e=>(0,t.jsx)(n.w,{className:"w-full",children:(0,t.jsxs)(r.G,{className:"space-y-2",children:[(0,t.jsx)(i.X,{className:"rounded-lg",children:(0,t.jsx)("div",{className:"h-3 w-3/4 rounded-lg bg-default-200"})}),(0,t.jsx)(i.X,{className:"rounded-lg",children:(0,t.jsx)("div",{className:"h-5 w-2/3 rounded-lg bg-default-200"})})]})},e))})]})}):"table"===s?(0,t.jsxs)("div",{className:"space-y-3 ".concat(a),children:[(0,t.jsx)("div",{className:"flex space-x-2 mb-4",children:[1,2,3,4].map(e=>(0,t.jsx)(i.X,{className:"rounded-lg",children:(0,t.jsx)("div",{className:"h-8 w-24 rounded-lg bg-default-200"})},e))}),[1,2,3,4,5].map(e=>(0,t.jsx)("div",{className:"flex space-x-4 items-center",children:(0,t.jsx)(i.X,{className:"rounded-lg",children:(0,t.jsx)("div",{className:"h-10 w-full rounded-lg bg-default-200"})})},e))]}):(0,t.jsx)("div",{className:"space-y-3 ".concat(a),children:[1,2,3,4,5].map(e=>(0,t.jsx)(n.w,{className:"w-full",children:(0,t.jsx)(r.G,{children:(0,t.jsxs)("div",{className:"flex justify-between items-center",children:[(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsx)(i.X,{className:"rounded-lg",children:(0,t.jsx)("div",{className:"h-3 w-24 rounded-lg bg-default-200"})}),(0,t.jsx)(i.X,{className:"rounded-lg",children:(0,t.jsx)("div",{className:"h-3 w-32 rounded-lg bg-default-200"})})]}),(0,t.jsx)(i.X,{className:"rounded-lg",children:(0,t.jsx)("div",{className:"h-6 w-20 rounded-lg bg-default-200"})})]})})},e))})}},20003:function(e,s,a){"use strict";a.d(s,{Hc:function(){return h},Oh:function(){return f},X$:function(){return v},YF:function(){return x},ao:function(){return g},cW:function(){return d},kN:function(){return j},l0:function(){return u},t3:function(){return y},vP:function(){return m}});var t=a(47082),n=a(94642),r=a(20568),i=a(64090),c=a(58222),l=a(96770),o=a(52131);function d(){let{user:e,updateUser:s}=(0,o.useAuth)(),a=(0,t.NL)(),{showToast:r}=(0,l.useToast)(),[d,u]=(0,i.useState)([]),m=(0,i.useRef)(!1),{data:x,isLoading:f,error:h}=(0,n.a)({queryKey:["families"],queryFn:async()=>{try{let e=await (0,c.Io)("/families/user");return m.current=!1,e.data}catch(e){throw console.error("获取家庭列表失败:",e),m.current=!0,e}},enabled:!!e,staleTime:3e5,retry:m.current?0:2}),y=null==x?void 0:x.find(s=>s.id===(null==e?void 0:e.currentFamilyId)),{data:j,isLoading:g,error:v}=(0,n.a)({queryKey:["familyMembers",null==e?void 0:e.currentFamilyId],queryFn:async()=>(await (0,c.Io)("/families/".concat(null==e?void 0:e.currentFamilyId,"/members"))).data,enabled:!!(null==e?void 0:e.currentFamilyId)&&!m.current,staleTime:3e5,gcTime:3e5,retry:1});(0,i.useEffect)(()=>{h&&console.error("获取家庭列表失败:",h)},[h]),(0,i.useEffect)(()=>{v&&console.error("获取家庭成员失败:",v)},[v]);let N=(0,i.useCallback)(t=>{e&&(s({...e,currentFamilyId:t.id}),a.invalidateQueries({queryKey:["familyMembers"]}),a.invalidateQueries({queryKey:["transactions"]}),a.invalidateQueries({queryKey:["categories"]}),a.invalidateQueries({queryKey:["statistics"]}),a.invalidateQueries({queryKey:["categoryStats"]}),a.invalidateQueries({queryKey:["recentTransactions"]}),localStorage.setItem("currentFamilyId",t.id.toString()))},[e,s,a]),w=(0,i.useCallback)(()=>(null==y?void 0:y.owner_id)===(null==e?void 0:e.id)||(null==j?void 0:j.some(s=>s.user_id===(null==e?void 0:e.id)&&"admin"===s.role)),[y,e,j]);return{families:x,members:j||d,currentFamily:y,isLoading:f||g,error:h,setCurrentFamily:N,isAdmin:w}}function u(){let e=(0,t.NL)(),{showToast:s}=(0,l.useToast)();return(0,r.D)({mutationFn:async e=>(await (0,c.Io)("/families",{method:"POST",body:JSON.stringify(e)})).data,onSuccess:()=>{s("家庭创建成功","success"),e.invalidateQueries({queryKey:["families"]})},onError:e=>{s("创建失败: ".concat(e.message),"error")}})}function m(){let e=(0,t.NL)(),{showToast:s}=(0,l.useToast)();return(0,r.D)({mutationFn:async e=>{let{familyId:s,data:a}=e;return(await (0,c.Io)("/families/".concat(s),{method:"PATCH",body:JSON.stringify(a)})).data},onSuccess:()=>{s("家庭信息已更新","success"),e.invalidateQueries({queryKey:["families"]})},onError:e=>{s("更新失败: ".concat(e.message),"error")}})}function x(){let e=(0,t.NL)(),{showToast:s}=(0,l.useToast)();return(0,r.D)({mutationFn:async e=>{await (0,c.Io)("/families/".concat(e),{method:"DELETE"})},onSuccess:()=>{s("家庭已删除","success"),e.invalidateQueries({queryKey:["families"]})},onError:e=>{s("删除失败: ".concat(e.message),"error")}})}function f(){let e=(0,t.NL)(),{showToast:s}=(0,l.useToast)();return(0,r.D)({mutationFn:async e=>{let{familyId:s,data:a}=e;return(await (0,c.Io)("/families/".concat(s,"/members"),{method:"POST",body:JSON.stringify(a)})).data},onSuccess:()=>{s("成员已添加","success"),e.invalidateQueries({queryKey:["family"]})},onError:e=>{s("添加失败: ".concat(e.message),"error")}})}function h(){let e=(0,t.NL)(),{showToast:s}=(0,l.useToast)();return(0,r.D)({mutationFn:async e=>{let{familyId:s,memberId:a,role:t}=e;return(await (0,c.Io)("/families/".concat(s,"/members/").concat(a),{method:"PATCH",body:JSON.stringify({role:t})})).data},onSuccess:()=>{s("成员角色已更新","success"),e.invalidateQueries({queryKey:["family"]})},onError:e=>{s("更新失败: ".concat(e.message),"error")}})}function y(){let e=(0,t.NL)(),{showToast:s}=(0,l.useToast)();return(0,r.D)({mutationFn:async e=>{let{familyId:s,memberId:a}=e;await (0,c.Io)("/families/".concat(s,"/members/").concat(a),{method:"DELETE"})},onSuccess:()=>{s("成员已移除","success"),e.invalidateQueries({queryKey:["family"]})},onError:e=>{s("移除失败: ".concat(e.message),"error")}})}function j(e){return(0,n.a)({queryKey:["familyInvitations",e],queryFn:async()=>e?(await (0,c.Io)("/families/".concat(e,"/invitations"))).data:[],enabled:!!e})}function g(){let e=(0,t.NL)(),{showToast:s}=(0,l.useToast)();return(0,r.D)({mutationFn:async e=>{let{familyId:s,invitationId:a}=e;await (0,c.Io)("/families/".concat(s,"/invitations/").concat(a),{method:"DELETE"})},onSuccess:()=>{s("邀请已删除","success"),e.invalidateQueries({queryKey:["familyInvitations"]})},onError:e=>{s("删除失败: ".concat(e.message),"error")}})}function v(e){return(0,n.a)({queryKey:["userInvitations",e],queryFn:async()=>e&&(await (0,c.Io)("/users/".concat(e,"/invitations"))).data||[],enabled:!!e})}}},function(e){e.O(0,[6034,9390,9689,7945,7530,2178,5784,224,4187,1945,414,568,4642,6373,1493,2131,2971,8069,1744],function(){return e(e.s=3695)}),_N_E=e.O()}]);