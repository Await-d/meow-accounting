(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[1304,2131],{48591:function(e,t,n){Promise.resolve().then(n.bind(n,56478))},56478:function(e,t,n){"use strict";n.r(t),n.d(t,{default:function(){return ee}});var r=n(3827),s=n(64090),a=n(2210),o=n(10732),i=n(88925),c=n(83176),l=n(67945),u=n(51055),d=n(70094),h=n(52131),m=n(47082),f=n(94642),v=n(20568),x=n(58222),y=n(14298),g=n(59584),p=n(55421),w=n(50489),j=n(3832),I=n(37841),S=n(77785);let A=[{header:"路径",accessorKey:"path"},{header:"名称",accessorKey:"name"},{header:"描述",accessorKey:"description"},{header:"权限",accessorKey:"permission",cell:e=>{let{row:t}=e,n=t.original.permission;return({[S.wI.PUBLIC]:"公开",[S.wI.PRIVATE]:"私有",[S.wI.FAMILY]:"家庭",[S.wI.ADMIN]:"管理员"})[n]||n}},{header:"状态",accessorKey:"is_active",cell:e=>{let{row:t}=e;return t.original.is_active?"启用":"禁用"}},{header:"创建时间",accessorKey:"created_at",cell:e=>{let{row:t}=e;return new Date(t.original.created_at).toLocaleString()}},{header:"更新时间",accessorKey:"updated_at",cell:e=>{let{row:t}=e;return new Date(t.original.updated_at).toLocaleString()}},{header:"操作",cell:e=>{let{row:t}=e,n=t.original;return(0,r.jsxs)("div",{className:"flex gap-2",children:[(0,r.jsx)(g.e,{content:"编辑",children:(0,r.jsx)(o.A,{isIconOnly:!0,size:"sm",variant:"light",onPress:()=>{var e;return null===(e=n.onEdit)||void 0===e?void 0:e.call(n,n)},children:(0,r.jsx)(p.Z,{className:"w-4 h-4"})})}),(0,r.jsx)(g.e,{content:"删除",children:(0,r.jsx)(o.A,{isIconOnly:!0,size:"sm",variant:"light",color:"danger",onPress:()=>{var e;return null===(e=n.onDelete)||void 0===e?void 0:e.call(n,n)},children:(0,r.jsx)(w.Z,{className:"w-4 h-4"})})}),(0,r.jsx)(g.e,{content:n.is_active?"禁用":"启用",children:(0,r.jsx)(o.A,{isIconOnly:!0,size:"sm",variant:"light",color:n.is_active?"warning":"success",onPress:()=>{var e;return null===(e=n.onToggleActive)||void 0===e?void 0:e.call(n,n)},children:(0,r.jsx)(j.Z,{className:"w-4 h-4"})})}),(0,r.jsx)(g.e,{content:"查看性能",children:(0,r.jsx)(o.A,{isIconOnly:!0,size:"sm",variant:"light",onPress:()=>{var e;return null===(e=n.onViewStats)||void 0===e?void 0:e.call(n,n)},children:(0,r.jsx)(I.Z,{className:"w-4 h-4"})})})]})}}];var T=n(4248),b=n(99510),P=n(22561),N=n(7725),E=n(47385),C=n(96459),O=n(56178),D=n(14078),R=n(49430),L=n(2646),F=n(82670),_=n(21270),M=n(30248);let Y=M.z.object({path:M.z.string().min(1,"路径不能为空"),name:M.z.string().min(1,"名称不能为空"),description:M.z.string(),type:M.z.nativeEnum(S.Yt),permission:M.z.nativeEnum(S.wI),is_active:M.z.boolean(),user_id:M.z.number().optional(),family_id:M.z.number().nullable().optional()});function K(e){let{isOpen:t,onClose:n,onSubmit:a,initialData:i}=e,{control:c,handleSubmit:l,formState:{errors:u,isSubmitting:d},reset:h}=(0,F.cI)({resolver:(0,_.F)(Y),defaultValues:i||{path:"",name:"",description:"",type:S.Yt.DASHBOARD,permission:S.wI.PRIVATE,is_active:!0}});s.useEffect(()=>{t&&h(i)},[t,i,h]);let m=async e=>{try{await a(e),n()}catch(e){console.error("Failed to submit route:",e)}};return(0,r.jsx)(T.R,{isOpen:t,onClose:n,size:"2xl",children:(0,r.jsx)(b.A,{children:(0,r.jsxs)("form",{onSubmit:l(m),children:[(0,r.jsx)(P.k,{children:i?"编辑路由":"新增路由"}),(0,r.jsxs)(N.I,{className:"space-y-4",children:[(0,r.jsx)(F.Qr,{name:"path",control:c,render:e=>{var t;let{field:n}=e;return(0,r.jsx)(E.Y,{...n,label:"路径",placeholder:"请输入路由路径",errorMessage:null===(t=u.path)||void 0===t?void 0:t.message,isInvalid:!!u.path})}}),(0,r.jsx)(F.Qr,{name:"name",control:c,render:e=>{var t;let{field:n}=e;return(0,r.jsx)(E.Y,{...n,label:"名称",placeholder:"请输入路由名称",errorMessage:null===(t=u.name)||void 0===t?void 0:t.message,isInvalid:!!u.name})}}),(0,r.jsx)(F.Qr,{name:"description",control:c,render:e=>{var t;let{field:n}=e;return(0,r.jsx)(C.Y,{...n,label:"描述",placeholder:"请输入路由描述",errorMessage:null===(t=u.description)||void 0===t?void 0:t.message,isInvalid:!!u.description})}}),(0,r.jsx)(F.Qr,{name:"type",control:c,render:e=>{var t;let{field:n}=e;return(0,r.jsxs)(O.g,{...n,label:"类型",errorMessage:null===(t=u.type)||void 0===t?void 0:t.message,isInvalid:!!u.type,children:[(0,r.jsx)(D.R,{value:S.Yt.DASHBOARD,children:"仪表盘"},S.Yt.DASHBOARD),(0,r.jsx)(D.R,{value:S.Yt.TRANSACTIONS,children:"交易记录"},S.Yt.TRANSACTIONS),(0,r.jsx)(D.R,{value:S.Yt.STATISTICS,children:"统计分析"},S.Yt.STATISTICS),(0,r.jsx)(D.R,{value:S.Yt.SETTINGS,children:"设置"},S.Yt.SETTINGS),(0,r.jsx)(D.R,{value:S.Yt.CUSTOM,children:"自定义页面"},S.Yt.CUSTOM)]})}}),(0,r.jsx)(F.Qr,{name:"permission",control:c,render:e=>{var t;let{field:n}=e;return(0,r.jsxs)(O.g,{...n,label:"权限",errorMessage:null===(t=u.permission)||void 0===t?void 0:t.message,isInvalid:!!u.permission,children:[(0,r.jsx)(D.R,{value:S.wI.PUBLIC,children:"公开，任何人可访问"},S.wI.PUBLIC),(0,r.jsx)(D.R,{value:S.wI.PRIVATE,children:"私有，仅创建者可访问"},S.wI.PRIVATE),(0,r.jsx)(D.R,{value:S.wI.FAMILY,children:"家庭，仅家庭成员可访问"},S.wI.FAMILY),(0,r.jsx)(D.R,{value:S.wI.ADMIN,children:"管理员，仅家庭管理员可访问"},S.wI.ADMIN)]})}}),(0,r.jsx)(F.Qr,{name:"is_active",control:c,render:e=>{let{field:t}=e;return(0,r.jsx)(R.i,{name:t.name,ref:t.ref,isSelected:t.value,onValueChange:t.onChange,children:"启用状态"})}})]}),(0,r.jsxs)(L.R,{children:[(0,r.jsx)(o.A,{color:"danger",variant:"light",onPress:n,children:"取消"}),(0,r.jsx)(o.A,{color:"primary",type:"submit",isLoading:d,children:"确定"})]})]})})})}var G=n(26587),z=n(66363),k=n(38333),U=n(23356),B=n(22983),q=n(10166),H=n(94866),V=n(98061),J=n(24897),Q=n(98308),W=n(74994);let Z=["#00C49F","#FF8042","#FFBB28","#FF0000"];function X(e){var t,n,s,a,i,c,d,h,m,v;let{isOpen:y,onClose:g,route:p}=e,{data:w,isLoading:j}=(0,f.a)({queryKey:["route-stats",null==p?void 0:p.id],queryFn:()=>(0,x.fM)(null==p?void 0:p.id),enabled:y&&!!(null==p?void 0:p.id)});if(!p)return null;let I=(null==w?void 0:null===(n=w.data)||void 0===n?void 0:null===(t=n.accessHistory)||void 0===t?void 0:t.map(e=>({time:new Date(e.timestamp).toLocaleString(),loadTime:e.loadTime,errorCount:e.errorCount})))||[],S=[{name:"成功访问",value:(null==w?void 0:null===(s=w.data)||void 0===s?void 0:s.totalAccesses)||0},{name:"缓存命中",value:(null==w?void 0:null===(a=w.data)||void 0===a?void 0:a.cacheHits)||0},{name:"错误次数",value:(null==w?void 0:null===(i=w.data)||void 0===i?void 0:i.totalErrors)||0}];return(0,r.jsx)(T.R,{isOpen:y,onClose:g,size:"3xl",scrollBehavior:"inside",children:(0,r.jsxs)(b.A,{children:[(0,r.jsxs)(P.k,{children:["路由性能统计 - ",p.name]}),(0,r.jsx)(N.I,{className:"space-y-6",children:j?(0,r.jsx)("div",{children:"加载中..."}):(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)("div",{className:"grid grid-cols-3 gap-4",children:[(0,r.jsx)(l.w,{children:(0,r.jsx)(u.G,{children:(0,r.jsxs)("div",{className:"text-center",children:[(0,r.jsx)("div",{className:"text-sm text-gray-500",children:"总访问次数"}),(0,r.jsx)("div",{className:"text-2xl font-bold",children:(null==w?void 0:null===(c=w.data)||void 0===c?void 0:c.totalAccesses)||0})]})})}),(0,r.jsx)(l.w,{children:(0,r.jsx)(u.G,{children:(0,r.jsxs)("div",{className:"text-center",children:[(0,r.jsx)("div",{className:"text-sm text-gray-500",children:"平均加载时间"}),(0,r.jsxs)("div",{className:"text-2xl font-bold",children:[(null==w?void 0:null===(h=w.data)||void 0===h?void 0:null===(d=h.averageLoadTime)||void 0===d?void 0:d.toFixed(2))||0,"ms"]})]})})}),(0,r.jsx)(l.w,{children:(0,r.jsx)(u.G,{children:(0,r.jsxs)("div",{className:"text-center",children:[(0,r.jsx)("div",{className:"text-sm text-gray-500",children:"错误率"}),(0,r.jsxs)("div",{className:"text-2xl font-bold",children:[(((null==w?void 0:null===(m=w.data)||void 0===m?void 0:m.totalErrors)||0)/((null==w?void 0:null===(v=w.data)||void 0===v?void 0:v.totalAccesses)||1)*100).toFixed(2),"%"]})]})})})]}),(0,r.jsx)(l.w,{children:(0,r.jsx)(u.G,{children:(0,r.jsx)("div",{className:"h-80",children:(0,r.jsx)(G.h,{width:"100%",height:"100%",children:(0,r.jsxs)(z.w,{data:I,children:[(0,r.jsx)(k.q,{strokeDasharray:"3 3"}),(0,r.jsx)(U.K,{dataKey:"time"}),(0,r.jsx)(B.B,{yAxisId:"left"}),(0,r.jsx)(B.B,{yAxisId:"right",orientation:"right"}),(0,r.jsx)(q.u,{}),(0,r.jsx)(H.D,{}),(0,r.jsx)(V.x,{yAxisId:"left",type:"monotone",dataKey:"loadTime",stroke:"#8884d8",name:"加载时间(ms)"}),(0,r.jsx)(V.x,{yAxisId:"right",type:"monotone",dataKey:"errorCount",stroke:"#ff0000",name:"错误次数"})]})})})})}),(0,r.jsx)(l.w,{children:(0,r.jsx)(u.G,{children:(0,r.jsx)("div",{className:"h-80",children:(0,r.jsx)(G.h,{width:"100%",height:"100%",children:(0,r.jsxs)(J.u,{children:[(0,r.jsx)(Q.b,{data:S,cx:"50%",cy:"50%",labelLine:!1,label:e=>{let{name:t,percent:n}=e;return"".concat(t,": ").concat((100*n).toFixed(0),"%")},outerRadius:80,fill:"#8884d8",dataKey:"value",children:S.map((e,t)=>(0,r.jsx)(W.b,{fill:Z[t%Z.length]},"cell-".concat(t)))}),(0,r.jsx)(q.u,{})]})})})})})]})}),(0,r.jsx)(L.R,{children:(0,r.jsx)(o.A,{color:"primary",onPress:g,children:"关闭"})})]})})}var $=n(56288);function ee(){var e,t;let{user:n,handleUnauthorized:g,isLoading:p}=(0,h.useAuth)(),w=(null==n?void 0:n.role)==="admin",j=(0,m.NL)(),{isOpen:I,onOpen:S,onClose:T}=(0,a.q)(),{isOpen:b,onOpen:P,onClose:N}=(0,a.q)(),[E,C]=s.useState(),{data:O,isLoading:D}=(0,f.a)({queryKey:["routes","all"],queryFn:async()=>{try{return await (0,x._c)()}catch(e){throw(null==e?void 0:e.status)===401?g():$.Am.error("获取路由失败: ".concat((null==e?void 0:e.message)||"未知错误")),e}},enabled:w}),R=(0,v.D)({mutationFn:x.ot,onSuccess:()=>{j.invalidateQueries({queryKey:["routes"]}),$.Am.success("创建成功"),T()},onError:e=>{$.Am.error("创建失败: "+e.message)}}),L=(0,v.D)({mutationFn:e=>(0,x.fq)(e,{}),onSuccess:()=>{j.invalidateQueries({queryKey:["routes"]}),$.Am.success("更新成功"),T()},onError:e=>{$.Am.error("更新失败: "+e.message)}}),F=(0,v.D)({mutationFn:x.qW,onSuccess:()=>{j.invalidateQueries({queryKey:["routes"]}),$.Am.success("删除成功")},onError:e=>{$.Am.error("删除失败: "+e.message)}}),_=(0,v.D)({mutationFn:x.rr,onSuccess:()=>{j.invalidateQueries({queryKey:["routes"]}),$.Am.success("状态更新成功")},onError:e=>{$.Am.error("状态更新失败: "+e.message)}}),M=async e=>{E?await L.mutateAsync(E.id):await R.mutateAsync(e)},Y=e=>{C(e),S()},G=async e=>{confirm("确定要删除该路由吗？")&&await F.mutateAsync(e.id)},z=async e=>{await _.mutateAsync(e.id)},k=e=>{C(e),P()},U=[...A,{header:"创建者",accessorKey:"user.username"}],B=[...A,{header:"所属家庭",accessorKey:"family.name"},{header:"创建者",accessorKey:"user.username"}],q=e=>e.map(e=>({...e,onEdit:Y,onDelete:G,onToggleActive:z,onViewStats:k}));return w?(0,r.jsxs)("div",{className:"w-full space-y-4",children:[(0,r.jsxs)("div",{className:"flex justify-between items-center",children:[(0,r.jsx)("h2",{className:"text-xl font-bold",children:"路由管理"}),(0,r.jsx)(o.A,{color:"primary",endContent:(0,r.jsx)(d.Z,{className:"w-4 h-4"}),onPress:()=>{C(void 0),S()},children:"新增路由"})]}),(0,r.jsxs)(i.n,{"aria-label":"路由类型",children:[(0,r.jsx)(c.r,{title:"个人路由",children:(0,r.jsx)(l.w,{children:(0,r.jsx)(u.G,{children:(0,r.jsx)(y.w,{columns:U,data:q((null==O?void 0:null===(e=O.data)||void 0===e?void 0:e.personalRoutes)||[]),isLoading:D,pagination:!0})})})},"personal"),(0,r.jsx)(c.r,{title:"家庭路由",children:(0,r.jsx)(l.w,{children:(0,r.jsx)(u.G,{children:(0,r.jsx)(y.w,{columns:B,data:q((null==O?void 0:null===(t=O.data)||void 0===t?void 0:t.familyRoutes)||[]),isLoading:D,pagination:!0})})})},"family")]}),(0,r.jsx)(K,{isOpen:I,onClose:T,onSubmit:M,initialData:E}),(0,r.jsx)(X,{isOpen:b,onClose:N,route:E})]}):(0,r.jsxs)("div",{className:"p-4",children:[(0,r.jsx)("h2",{className:"text-xl font-bold mb-4",children:"无权访问"}),(0,r.jsx)("p",{children:"只有管理员可以访问此页面"})]})}},14298:function(e,t,n){"use strict";n.d(t,{w:function(){return m}});var r=n(3827),s=n(64090),a=n(50535),o=n(9410),i=n(75129),c=n(63053),l=n(77058),u=n(45623),d=n(36685),h=n(92339);function m(e){let{columns:t,data:n,isLoading:m=!1,pagination:f=!1,pageSize:v=10}=e,[x,y]=s.useState(1),g=Math.ceil(n.length/v),p=s.useMemo(()=>{let e=(x-1)*v,t=e+v;return n.slice(e,t)},[x,n,v]),w=s.useCallback((e,n)=>{let r=t.find(e=>e.accessorKey===n);return(null==r?void 0:r.cell)?r.cell({row:{original:e}}):e[n]},[t]);return(0,r.jsx)("div",{className:"w-full",children:(0,r.jsxs)(a.b,{"aria-label":"数据表格",bottomContent:f&&g>1?(0,r.jsx)("div",{className:"flex w-full justify-center",children:(0,r.jsx)(o.g,{isCompact:!0,showControls:!0,showShadow:!0,color:"primary",page:x,total:g,onChange:y})}):null,children:[(0,r.jsx)(i.J,{children:t.map((e,t)=>(0,r.jsx)(c.j,{children:e.header},e.accessorKey||"column-".concat(t)))}),(0,r.jsx)(l.y,{items:p,loadingContent:(0,r.jsx)(u.c,{}),isLoading:m,emptyContent:m?null:"暂无数据",children:e=>(0,r.jsx)(d.g,{children:t.map(t=>(0,r.jsx)(h.X,{children:w(e,t.accessorKey)},t.accessorKey))},e.id)})]})})}},96770:function(e,t,n){"use strict";n.r(t),n.d(t,{ToastProvider:function(){return c},useToast:function(){return i}});var r=n(3827),s=n(64090),a=n(10963);let o=(0,s.createContext)(void 0);function i(){let e=(0,s.useContext)(o);if(!e)throw Error("useToast must be used within a ToastProvider");return e}function c(e){let{children:t}=e;return(0,r.jsxs)(o.Provider,{value:{showToast:function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"info",n={duration:3e3,style:{padding:"16px",borderRadius:"8px"}};switch(t){case"success":a.Am.success(e,n);break;case"error":a.Am.error(e,n);break;case"warning":(0,a.Am)(e,{...n,icon:"⚠️"});break;default:(0,a.Am)(e,{...n,icon:"ℹ️"})}}},children:[t,(0,r.jsx)(a.x7,{position:"top-center"})]})}},26632:function(e,t,n){"use strict";n.d(t,{AW:function(){return a},Kz:function(){return s},P8:function(){return o}});var r=n(77785);let s={[r.Yt.DASHBOARD]:{component:()=>Promise.all([n.e(7674),n.e(6034),n.e(9390),n.e(9689),n.e(7945),n.e(7530),n.e(9178),n.e(3614),n.e(5784),n.e(7385),n.e(6288),n.e(224),n.e(4187),n.e(1945),n.e(8704),n.e(414),n.e(4322),n.e(568),n.e(5961),n.e(4642),n.e(4788),n.e(6373),n.e(8792),n.e(5769),n.e(1581),n.e(6573),n.e(9430),n.e(3135),n.e(2616),n.e(5626),n.e(3530),n.e(7456),n.e(2949),n.e(7923),n.e(8026)]).then(n.bind(n,27923)).then(e=>e.default),permission:r.wI.PRIVATE,layout:()=>Promise.all([n.e(9390),n.e(9178),n.e(3614),n.e(7108)]).then(n.bind(n,17108)).then(e=>e.default)},[r.Yt.TRANSACTIONS]:{component:()=>Promise.all([n.e(6034),n.e(9390),n.e(9689),n.e(7945),n.e(7530),n.e(9178),n.e(3614),n.e(5784),n.e(7385),n.e(6288),n.e(224),n.e(4187),n.e(1945),n.e(8704),n.e(414),n.e(4322),n.e(568),n.e(5961),n.e(4788),n.e(1581),n.e(2616),n.e(3121),n.e(7456),n.e(1731)]).then(n.bind(n,47646)).then(e=>e.default),permission:r.wI.FAMILY,layout:()=>Promise.all([n.e(6034),n.e(9390),n.e(9689),n.e(7945),n.e(7530),n.e(9178),n.e(3614),n.e(6288),n.e(3121),n.e(3345)]).then(n.bind(n,33345)).then(e=>e.default)},[r.Yt.STATISTICS]:{component:()=>Promise.all([n.e(7674),n.e(6034),n.e(9390),n.e(9689),n.e(7945),n.e(7530),n.e(9178),n.e(3614),n.e(5784),n.e(7385),n.e(6288),n.e(224),n.e(4187),n.e(1945),n.e(8704),n.e(414),n.e(4322),n.e(568),n.e(5961),n.e(4642),n.e(4788),n.e(6373),n.e(8792),n.e(5769),n.e(1581),n.e(6573),n.e(3121),n.e(7456),n.e(2949),n.e(7641)]).then(n.bind(n,87641)).then(e=>e.default),permission:r.wI.FAMILY,layout:()=>Promise.all([n.e(6034),n.e(9390),n.e(9689),n.e(7945),n.e(7530),n.e(9178),n.e(3614),n.e(6288),n.e(3121),n.e(8891)]).then(n.bind(n,18891)).then(e=>e.default)},[r.Yt.SETTINGS]:{component:()=>Promise.all([n.e(6034),n.e(9390),n.e(9689),n.e(7945),n.e(1077)]).then(n.bind(n,1077)).then(e=>e.default),permission:r.wI.PRIVATE,layout:()=>Promise.all([n.e(6034),n.e(9390),n.e(9689),n.e(7945),n.e(9178),n.e(3614),n.e(8792),n.e(1207)]).then(n.bind(n,31207)).then(e=>e.default)},[r.Yt.CUSTOM]:{component:()=>Promise.all([n.e(6034),n.e(9390),n.e(9689),n.e(7945),n.e(9178),n.e(3614),n.e(6288),n.e(3121),n.e(7386)]).then(n.bind(n,7386)).then(e=>e.default),permission:r.wI.PRIVATE,layout:()=>Promise.all([n.e(6034),n.e(9390),n.e(9689),n.e(7945),n.e(7530),n.e(9178),n.e(3614),n.e(510)]).then(n.bind(n,20510)).then(e=>e.default)}};function a(e,t,n,a){switch(s[e],t){case r.wI.PUBLIC:return!0;case r.wI.PRIVATE:return!!n;case r.wI.FAMILY:case r.wI.ADMIN:return!!n&&!!a;default:return!1}}async function o(e,t){let n=s[t];if(!n)throw Error("未找到路由类型 ".concat(t," 对应的组件"));try{let e=await n.component(),t=n.layout?await n.layout():null;return{Component:e,Layout:t,permission:n.permission}}catch(e){throw console.error("加载路由组件失败: ".concat(e)),e}}},52131:function(e,t,n){"use strict";n.r(t),n.d(t,{AuthProvider:function(){return y},useAuth:function(){return g}});var r=n(3827),s=n(64090),a=n(47907),o=n(96770),i=n(58222),c=n(94564),l=n(37963),u=n(77785),d=n(26632);let h=async e=>{let t=await (0,i.Io)("/auth/login",{method:"POST",body:JSON.stringify(e)});return console.log("ssss",t),t.data},m=async e=>(await (0,i.Io)("/auth/register",{method:"POST",body:JSON.stringify(e)})).data,f=async e=>(await (0,i.Io)("/auth/verify-guest",{method:"POST",body:JSON.stringify({password:e})})).data,v=async e=>(await (0,i.Io)("/user/settings",{method:"PATCH",body:JSON.stringify(e)})).data,x=(0,s.createContext)(void 0);function y(e){let{children:t}=e,[n,i]=(0,s.useState)(null),[y,g]=(0,s.useState)(!1),[p,w]=(0,s.useState)(!1),j=(0,a.useRouter)(),{showToast:I}=(0,o.useToast)(),S=e=>{try{let t=(0,l.o)(e),n=Date.now()/1e3;if(t.exp&&t.exp<n)return(0,c.gy)(),localStorage.removeItem("isGuest"),null;return{id:t.id,username:t.username,email:t.email,role:t.role,privacy_mode:t.privacy_mode,default_route:t.default_route,permissions:t.permissions}}catch(e){return console.error("解析 token 失败:",e),(0,c.gy)(),localStorage.removeItem("isGuest"),null}},A=async e=>{if(!e||!e.default_route){j.push("/dashboard");return}try{let t=e.default_route,n=t.split("/")[1];if(!(0,d.AW)(n,u.wI.PRIVATE,"string"==typeof e.id?parseInt(e.id,10):e.id,e.currentFamilyId?"string"==typeof e.currentFamilyId?parseInt(e.currentFamilyId,10):e.currentFamilyId:void 0)){console.warn("用户无权访问默认路由，重定向到仪表盘"),j.push("/dashboard");return}await (0,d.P8)(t,n),j.push(t)}catch(e){console.error("路由导航失败:",e),j.push("/dashboard")}};(0,s.useEffect)(()=>{let e=(0,c.LP)(),t="true"===localStorage.getItem("isGuest"),n=window.location.pathname,r=n.startsWith("/auth/"),s="/"===n||"/about"===n;if(e){let n=S(e);n?(i(n),g(t),r&&A(n)):r||s||j.push("/auth/login")}else r||s||j.push("/auth/login")},[j]);let T=async(e,t)=>{try{let{token:n,user:r}=await h({email:e,password:t});(0,c.o4)(n),i(r),g(!1),localStorage.setItem("isGuest","false"),I("登录成功","success"),A(r)}catch(e){throw I("登录失败","error"),e}},b=async e=>{try{let{token:t,user:n}=await m(e);(0,c.o4)(t),i(n),g(!1),localStorage.setItem("isGuest","false"),I("注册成功","success"),A(n)}catch(e){throw I("注册失败","error"),e}},P=async e=>{try{await f(e),g(!0),localStorage.setItem("isGuest","true")}catch(e){throw e}},N=async e=>{try{let t=await v(e);return i(t),t}catch(e){throw e instanceof Error?I(e.message,"error"):I("更新设置失败","error"),e}};return(0,r.jsx)(x.Provider,{value:{user:n,isGuest:y,isLoading:p,setUser:i,updateUser:e=>{i(e)},updateSettings:N,login:T,register:b,logout:()=>{(0,c.gy)(),localStorage.removeItem("isGuest"),i(null),g(!1),j.push("/auth/login")},enterGuestMode:P,exitGuestMode:()=>{g(!1),localStorage.removeItem("isGuest")},handleUnauthorized:()=>{(0,c.gy)(),localStorage.removeItem("isGuest"),localStorage.removeItem("currentFamilyId"),i(null),g(!1),"/auth/login"!==window.location.pathname&&(I("登录已过期，请重新登录","error"),j.push("/auth/login"))}},children:t})}function g(){let e=(0,s.useContext)(x);if(void 0===e)throw Error("useAuth must be used within an AuthProvider");return e}},58222:function(e,t,n){"use strict";n.d(t,{AW:function(){return P},Cp:function(){return D},Ds:function(){return f},HL:function(){return g},Hb:function(){return c},Io:function(){return h},KX:function(){return x},M$:function(){return R},Ml:function(){return C},Nq:function(){return N},Ny:function(){return p},P9:function(){return w},R5:function(){return O},_c:function(){return j},dx:function(){return v},fM:function(){return b},fq:function(){return S},h8:function(){return E},hQ:function(){return l},le:function(){return y},ot:function(){return I},qW:function(){return A},rr:function(){return T},we:function(){return m}});var r=n(77785),s=n(94564);let a=n(49079).env.NEXT_PUBLIC_API_URL||"http://localhost:3001/api",o=null,i=null;function c(e){o=e}function l(e){i=e}function u(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"error";i?i(e,t):console["error"===t?"error":"warning"===t?"warn":"log"](e)}let d={400:e=>{console.warn("请求参数错误: ".concat(e)),u("请求参数错误: ".concat(e),"warning")},401:e=>{(0,s.gy)(),localStorage.removeItem("isGuest"),localStorage.removeItem("currentFamilyId"),o?o():"/auth/login"!==window.location.pathname&&(u("登录已过期，请重新登录"+window.location.pathname,"error"),window.location.href="/auth/login")},403:e=>{console.warn("无权访问: ".concat(e)),u("无权访问: ".concat(e),"error")},404:e=>{console.warn("资源不存在: ".concat(e)),u("资源不存在: ".concat(e),"warning")},422:e=>{console.warn("数据验证失败: ".concat(e)),u("数据验证失败: ".concat(e),"warning")},429:e=>{console.warn("请求过多，请稍后再试: ".concat(e)),u("请求过多，请稍后再试","warning")},500:e=>{console.error("服务器错误: ".concat(e)),u("服务器内部错误，请稍后再试: ".concat(e),"error")},502:e=>{console.error("网关错误: ".concat(e)),u("服务器网关错误，请稍后再试","error")},503:e=>{console.error("服务不可用: ".concat(e)),u("服务暂时不可用，请稍后再试","error")},504:e=>{console.error("网关超时: ".concat(e)),u("请求超时，请检查网络连接后重试","error")}};async function h(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n="".concat(a).concat(e),o=(0,s.LP)(),i={"Content-Type":"application/json",...o?{Authorization:"Bearer ".concat(o)}:{}};try{let e=await fetch(n,{...t,headers:{...i,...t.headers}}),s=await e.json();if(console.log("sssssss",s),!e.ok){let t=d[e.status];throw t&&t(s.message||"请求失败"),new r.Hx(e.status,s.message||"请求失败")}return{data:s,message:s.message,status:e.status}}catch(e){if(e instanceof r.Hx)throw e;throw new r.Hx(500,e instanceof Error?e.message:"网络错误")}}let m=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"请求失败";if(e instanceof r.Hx)switch(e.status){case 400:return"请求参数错误: ".concat(e.message);case 403:return"无权访问: ".concat(e.message);case 404:return"资源不存在: ".concat(e.message);case 429:return"请求过于频繁，请稍后再试";case 500:case 502:case 503:return"服务器错误: ".concat(e.message);default:return e.message||t}return(null==e?void 0:e.message)||t};async function f(e){return(await h("/routes/predictions?user_id=".concat(e),{method:"GET"})).data}async function v(e){return(await h("/routes/".concat(e,"/optimization"),{method:"GET"})).data}async function x(e){let t=new URLSearchParams;e.startDate&&t.append("startDate",e.startDate),e.endDate&&t.append("endDate",e.endDate),e.routeIds&&e.routeIds.length>0&&e.routeIds.forEach(e=>t.append("routeIds[]",e.toString()));let n="".concat(a,"/routes/export?").concat(t.toString(),"&format=").concat(e.format),o=(0,s.LP)(),i=await fetch(n,{method:"GET",headers:{...o?{Authorization:"Bearer ".concat(o)}:{}}});if(!i.ok){let e=await i.json();throw new r.Hx(i.status,e.message||"导出失败")}return await i.blob()}async function y(e){let t=new URLSearchParams;return t.append("type",e.type),e.startDate&&t.append("startDate",e.startDate),e.endDate&&t.append("endDate",e.endDate),e.routeIds&&e.routeIds.length>0&&e.routeIds.forEach(e=>t.append("routeIds[]",e.toString())),(await h("/routes/visualization?".concat(t.toString()),{method:"GET"})).data}async function g(e){return h("/categories",{method:"POST",body:JSON.stringify(e)})}async function p(e,t){return h("/categories/".concat(e),{method:"PUT",body:JSON.stringify(t)})}async function w(e){return h("/categories/".concat(e),{method:"DELETE"})}async function j(){return h("/routes")}async function I(e){return h("/routes",{method:"POST",body:JSON.stringify(e)})}async function S(e,t){return h("/routes/".concat(e),{method:"PUT",body:JSON.stringify(t)})}async function A(e){return h("/routes/".concat(e),{method:"DELETE"})}async function T(e){return h("/routes/".concat(e,"/toggle"),{method:"POST"})}async function b(e){return h("/routes/".concat(e,"/stats"))}async function P(){return h("/users")}async function N(e,t){return h("/users/".concat(e),{method:"PUT",body:JSON.stringify(t)})}async function E(e){return h("/users/".concat(e),{method:"DELETE"})}async function C(e){return h("/users/".concat(e,"/freeze"),{method:"POST"})}async function O(e){return h("/users/".concat(e,"/unfreeze"),{method:"POST"})}async function D(e){return h("/auth/change-password",{method:"POST",body:JSON.stringify(e)})}async function R(e){return h("/users/privacy",{method:"PUT",body:JSON.stringify(e)})}},77785:function(e,t,n){"use strict";var r,s,a,o;n.d(t,{Hx:function(){return i},Yt:function(){return r},wI:function(){return s}});class i extends Error{constructor(e,t){super(t),this.status=e,this.name="APIError"}}(a=r||(r={})).DASHBOARD="dashboard",a.TRANSACTIONS="transactions",a.STATISTICS="statistics",a.SETTINGS="settings",a.CUSTOM="custom",(o=s||(s={})).PUBLIC="public",o.PRIVATE="private",o.FAMILY="family",o.ADMIN="admin"},94564:function(e,t,n){"use strict";function r(){return localStorage.getItem("token")}function s(e){localStorage.setItem("token",e)}function a(){localStorage.removeItem("token")}n.d(t,{LP:function(){return r},gy:function(){return a},o4:function(){return s}})}},function(e){e.O(0,[6034,9390,9689,7945,7530,9178,3614,2178,5784,7385,6288,224,4187,1945,8704,414,4322,568,5961,4642,4788,6373,5769,9430,3135,5626,248,1300,2971,8069,1744],function(){return e(e.s=48591)}),_N_E=e.O()}]);