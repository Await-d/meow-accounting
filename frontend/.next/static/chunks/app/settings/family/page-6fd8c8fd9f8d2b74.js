(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[7158,2131],{8672:function(e,s,t){Promise.resolve().then(t.bind(t,28719))},70699:function(e,s,t){"use strict";t.d(s,{Z:function(){return a}});let a=(0,t(57977).Z)("Save",[["path",{d:"M15.2 3a2 2 0 0 1 1.4.6l3.8 3.8a2 2 0 0 1 .6 1.4V19a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2z",key:"1c8476"}],["path",{d:"M17 21v-7a1 1 0 0 0-1-1H8a1 1 0 0 0-1 1v7",key:"1ydtos"}],["path",{d:"M7 3v4a1 1 0 0 0 1 1h7",key:"t51u73"}]])},28719:function(e,s,t){"use strict";t.r(s),t.d(s,{default:function(){return X}});var a=t(3827),n=t(64090),r=t(2210),i=t(63983),l=t(88925),c=t(83176),o=t(67945),d=t(51055),u=t(10732),m=t(50535),h=t(75129),x=t(63053),f=t(77058),j=t(36685),p=t(92339),y=t(49977),v=t(56178),g=t(14078),b=t(47385),N=t(26856),w=t(49430),I=t(4248),S=t(99510),P=t(22561),A=t(7725),T=t(2646),E=t(1310),z=t(25548),O=t(24424);let C=n.forwardRef(function(e,s){let{title:t,titleId:a,...r}=e;return n.createElement("svg",Object.assign({xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",strokeWidth:1.5,stroke:"currentColor","aria-hidden":"true","data-slot":"icon",ref:s,"aria-labelledby":a},r),t?n.createElement("title",{id:a},t):null,n.createElement("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M18 7.5v3m0 0v3m0-3h3m-3 0h-3m-2.25-4.125a3.375 3.375 0 1 1-6.75 0 3.375 3.375 0 0 1 6.75 0ZM3 19.235v-.11a6.375 6.375 0 0 1 12.75 0v.109A12.318 12.318 0 0 1 9.374 21c-2.331 0-4.512-.645-6.374-1.766Z"}))});var k=t(62707),D=t(70699),_=t(20003),L=t(96770),F=t(52131),q=t(47082),G=t(58222),R=t(94642),K=t(20568),Z=t(33684),M=t(69426);function H(e){let{isOpen:s,onClose:t,onSubmit:r,role:i,permissions:l=[],isLoading:c}=e,[o,d]=(0,n.useState)({name:"",description:"",permissions:[]});(0,n.useEffect)(()=>{i?d({name:i.name,description:i.description,permissions:i.permissions.map(e=>e.code)}):d({name:"",description:"",permissions:[]})},[i]);let m=l.reduce((e,s)=>{let t=s.code.split(":")[0];return e[t]||(e[t]=[]),e[t].push(s),e},{});return(0,a.jsx)(I.R,{isOpen:s,onClose:t,size:"2xl",scrollBehavior:"inside",classNames:{base:"max-w-2xl mx-auto",header:"border-b border-default-100 pb-2",body:"py-6",footer:"border-t border-default-100 pt-2"},backdrop:"blur",children:(0,a.jsxs)(S.A,{children:[(0,a.jsxs)(P.k,{className:"flex flex-col gap-1",children:[(0,a.jsx)("h3",{className:"text-xl font-bold",children:i?"编辑角色":"创建角色"}),(0,a.jsx)("p",{className:"text-sm text-default-500",children:i?"修改角色信息和权限":"创建新的角色并设置权限"})]}),(0,a.jsx)(A.I,{children:(0,a.jsxs)("div",{className:"space-y-6",children:[(0,a.jsx)(b.Y,{label:"角色名称",placeholder:"请输入角色名称",value:o.name,onChange:e=>d({...o,name:e.target.value}),variant:"bordered",isRequired:!0,isDisabled:null==i?void 0:i.isSystem}),(0,a.jsx)(b.Y,{label:"角色描述",placeholder:"请输入角色描述",value:o.description,onChange:e=>d({...o,description:e.target.value}),variant:"bordered",isDisabled:null==i?void 0:i.isSystem}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-sm font-medium mb-2",children:"权限设置"}),(0,a.jsx)(Z.o,{className:"h-[300px]",children:(0,a.jsx)("div",{className:"space-y-6",children:Object.entries(m).map(e=>{let[s,t]=e;return(0,a.jsxs)("div",{className:"space-y-2",children:[(0,a.jsx)("h4",{className:"font-medium capitalize",children:s}),(0,a.jsx)("div",{className:"grid grid-cols-2 gap-2",children:t.map(e=>(0,a.jsx)(M.K,{isSelected:o.permissions.includes(e.code),onValueChange:s=>{d(t=>({...t,permissions:s?[...t.permissions,e.code]:t.permissions.filter(s=>s!==e.code)}))},isDisabled:null==i?void 0:i.isSystem,children:(0,a.jsxs)("div",{children:[(0,a.jsx)("p",{className:"text-sm",children:e.name}),(0,a.jsx)("p",{className:"text-xs text-default-500",children:e.description})]})},e.code))})]},s)})})})]})]})}),(0,a.jsxs)(T.R,{children:[(0,a.jsx)(u.A,{variant:"bordered",onPress:t,className:"min-w-[80px]",children:"取消"}),(0,a.jsx)(u.A,{color:"primary",onPress:()=>{o.name&&r(o)},className:"min-w-[80px]",isLoading:c,isDisabled:!o.name||(null==i?void 0:i.isSystem),children:"确定"})]})]})})}var Y=t(56732);function X(){let{families:e,members:s,isLoading:t,currentFamily:Z,setCurrentFamily:M}=(0,_.cW)(),{data:X,isLoading:Q}=(0,_.kN)(null==Z?void 0:Z.id),{mutate:U}=(0,_.l0)(),{mutate:J}=(0,_.vP)(),{mutate:V}=(0,_.YF)(),{mutate:B,data:W}=(0,_.Oh)(),{mutate:$}=(0,_.Hc)(),{mutate:ee}=(0,_.t3)(),{mutate:es}=(0,_.ao)(),{isOpen:et,onOpen:ea,onClose:en}=(0,r.q)(),{isOpen:er,onOpen:ei,onClose:el}=(0,r.q)(),{isOpen:ec,onOpen:eo,onClose:ed}=(0,r.q)(),[eu,em]=(0,n.useState)(null),{settings:eh,isLoading:ex,updateSettings:ef}=function(e){let s=(0,q.NL)(),{showToast:t}=(0,L.useToast)(),{data:a,isLoading:n}=(0,R.a)({queryKey:["familySettings",e],queryFn:async()=>e?(await (0,G.Io)("/families/".concat(e,"/settings"))).data:null,enabled:!!e}),{mutate:r}=(0,K.D)({mutationFn:async s=>{if(!e)throw Error("No family selected");return(await (0,G.Io)("/families/".concat(e,"/settings"),{method:"PATCH",body:JSON.stringify(s)})).data},onSuccess:()=>{t("设置已保存","success"),s.invalidateQueries({queryKey:["familySettings",e]})},onError:e=>{t("保存设置失败: ".concat(e.message),"error")}});return{settings:a,isLoading:n,updateSettings:r}}(null==Z?void 0:Z.id),[ej,ep]=(0,n.useState)({defaultSharedBooks:!1,expenseLimitAlert:!1,newMemberNotification:!0,largeExpenseNotification:!0,budgetOverspendingNotification:!0}),[ey,ev]=(0,n.useState)(null),[eg,eb]=(0,n.useState)({name:"",description:""}),[eN,ew]=(0,n.useState)({email:"",role:"member",isGeneric:!1,expiresInHours:48,maxUses:1}),{showToast:eI}=(0,L.useToast)(),{user:eS}=(0,F.useAuth)(),{data:eP,isLoading:eA,refetch:eT}=(0,_.X$)(null==eS?void 0:eS.id),[eE,ez]=(0,n.useState)(null),[eO,eC]=(0,n.useState)("members"),[ek,eD]=(0,n.useState)("families"),e_=(0,q.NL)(),{roles:eL,permissions:eF,isLoading:eq,createRole:eG,updateRole:eR,deleteRole:eK}=function(e){let s=(0,q.NL)(),{showToast:t}=(0,L.useToast)(),{data:a,isLoading:n}=(0,R.a)({queryKey:["roles",e],queryFn:async()=>e?(await (0,G.Io)("/families/".concat(e,"/roles"))).data:[],enabled:!!e}),{data:r}=(0,R.a)({queryKey:["permissions"],queryFn:async()=>(await (0,G.Io)("/permissions")).data}),{mutate:i}=(0,K.D)({mutationFn:async s=>{if(!e)throw Error("No family selected");return(await (0,G.Io)("/families/".concat(e,"/roles"),{method:"POST",body:JSON.stringify(s)})).data},onSuccess:()=>{t("角色创建成功","success"),s.invalidateQueries({queryKey:["roles",e]})},onError:e=>{t("创建角色失败: ".concat(e.message),"error")}}),{mutate:l}=(0,K.D)({mutationFn:async s=>{let{roleId:t,data:a}=s;if(!e)throw Error("No family selected");return(await (0,G.Io)("/families/".concat(e,"/roles/").concat(t),{method:"PATCH",body:JSON.stringify(a)})).data},onSuccess:()=>{t("角色更新成功","success"),s.invalidateQueries({queryKey:["roles",e]})},onError:e=>{t("更新角色失败: ".concat(e.message),"error")}}),{mutate:c}=(0,K.D)({mutationFn:async s=>{if(!e)throw Error("No family selected");await (0,G.Io)("/families/".concat(e,"/roles/").concat(s),{method:"DELETE"})},onSuccess:()=>{t("角色删除成功","success"),s.invalidateQueries({queryKey:["roles",e]})},onError:e=>{t("删除角色失败: ".concat(e.message),"error")}});return{roles:a,permissions:r,isLoading:n,createRole:i,updateRole:l,deleteRole:c}}(null==Z?void 0:Z.id),[eZ,eM]=(0,n.useState)(void 0),{isOpen:eH,onOpen:eY,onClose:eX}=(0,r.q)(),eQ=(0,n.useMemo)(()=>{if(!Z||!eS)return!1;if(Z.owner_id===eS.id)return!0;let e=null==s?void 0:s.find(e=>e.user_id===eS.id);return(null==e?void 0:e.role)==="admin"},[Z,eS,s]);(0,n.useEffect)(()=>{console.log("刷新用户邀请"),eT().catch(e=>{console.error("刷新用户邀请失败:",e),eI("获取邀请失败","error")})},[eT,eI]),(0,n.useEffect)(()=>{console.log("收到的邀请数据:",eP)},[eP]),(0,n.useEffect)(()=>{eh&&"object"==typeof eh&&ep(eh)},[eh]);let eU=(e,s)=>{ep(t=>({...t,[e]:s}))},eJ=e=>{em(e),ei()},eV=async(e,s)=>{Z&&$({familyId:Z.id,memberId:e,role:s})},eB=e=>{Z&&(console.log("准备移除成员:",e),ev(e),ei())},eW=async e=>{try{await (0,G.Io)("/families/invitations/".concat(e,"/accept"),{method:"POST"}),eI("已成功加入家庭","success"),eT(),e_.invalidateQueries({queryKey:["families"]})}catch(e){console.error("接受邀请失败:",e),eI("接受邀请失败","error")}},e$=async e=>{try{await (0,G.Io)("/families/invitations/".concat(e,"/reject"),{method:"POST"}),eI("已拒绝邀请","success"),eT()}catch(e){console.error("拒绝邀请失败:",e),eI("拒绝邀请失败","error")}},e0=e=>{eM(e),eY()},e4=e=>{confirm('确定要删除角色 "'.concat(e.name,'" 吗？'))&&eK(e.id)};return t?(0,a.jsx)(i.X,{className:"h-64 rounded-lg"}):(0,a.jsxs)("div",{className:"space-y-8 max-w-6xl mx-auto",children:[(0,a.jsxs)(l.n,{"aria-label":"主选项卡",selectedKey:ek,onSelectionChange:e=>eD(e),className:"mb-4",children:[(0,a.jsxs)(c.r,{title:"家庭管理",children:[(0,a.jsx)(o.w,{className:"shadow-sm hover:shadow-md transition-shadow duration-200",children:(0,a.jsxs)(d.G,{className:"p-6",children:[(0,a.jsxs)("div",{className:"flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("h2",{className:"text-2xl font-bold text-primary",children:"我的家庭"}),(0,a.jsx)("p",{className:"text-sm text-default-500 mt-1",children:"管理您的家庭信息和成员"})]}),(0,a.jsx)(u.A,{color:"primary",startContent:(0,a.jsx)(E.Z,{className:"h-5 w-5"}),onPress:()=>{em(null),eb({name:"",description:""}),ea()},size:"md",className:"min-w-[140px]",children:"创建家庭"})]}),(0,a.jsx)("div",{className:"overflow-x-auto",children:(0,a.jsxs)(m.b,{"aria-label":"家庭列表",classNames:{base:"min-w-full",table:"min-w-full",thead:"bg-default-50",th:"text-default-700 font-semibold",tr:"hover:bg-default-50 transition-colors border-b border-default-100"},children:[(0,a.jsxs)(h.J,{children:[(0,a.jsx)(x.j,{className:"text-sm",children:"名称"}),(0,a.jsx)(x.j,{className:"text-sm",children:"描述"}),(0,a.jsx)(x.j,{className:"text-sm",children:"成员数"}),(0,a.jsx)(x.j,{className:"text-sm",children:"状态"}),(0,a.jsx)(x.j,{className:"text-sm",children:"操作"})]}),(0,a.jsx)(f.y,{items:e||[],emptyContent:"暂无家庭，点击右上角创建",children:e=>{var s;return(0,a.jsxs)(j.g,{className:"h-14",children:[(0,a.jsx)(p.X,{children:(0,a.jsx)("div",{className:"font-medium",children:e.name})}),(0,a.jsx)(p.X,{children:(0,a.jsx)("div",{className:"text-default-500",children:e.description||"无描述"})}),(0,a.jsx)(p.X,{children:(0,a.jsxs)(y.z,{color:"primary",variant:"flat",size:"sm",children:[(null===(s=e.members)||void 0===s?void 0:s.length)||0," 人"]})}),(0,a.jsx)(p.X,{children:(0,a.jsx)(y.z,{color:(null==Z?void 0:Z.id)===e.id?"success":"default",variant:"flat",size:"sm",className:"capitalize",children:(null==Z?void 0:Z.id)===e.id?"当前":"未选择"})}),(0,a.jsx)(p.X,{children:(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsx)(u.A,{size:"sm",variant:"flat",color:"primary",onPress:()=>M(e),isDisabled:(null==Z?void 0:Z.id)===e.id,className:"min-w-[80px]",children:(null==Z?void 0:Z.id)===e.id?"已选择":"切换"}),(0,a.jsx)(u.A,{isIconOnly:!0,size:"sm",variant:"light",color:"primary",onPress:()=>{em(e),eb(e),ea()},className:"rounded-full",children:(0,a.jsx)(z.Z,{className:"h-4 w-4"})}),(0,a.jsx)(u.A,{isIconOnly:!0,size:"sm",color:"danger",variant:"light",onPress:()=>eJ(e),isDisabled:e.owner_id!==(null==eS?void 0:eS.id),className:"rounded-full",children:(0,a.jsx)(O.Z,{className:"h-4 w-4"})})]})})]},e.id)}})]})})]})}),Z&&(0,a.jsx)(o.w,{className:"shadow-sm hover:shadow-md transition-shadow duration-200 mt-8",children:(0,a.jsxs)(d.G,{className:"p-6",children:[(0,a.jsxs)("div",{className:"flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("h2",{className:"text-2xl font-bold",children:Z.name}),(0,a.jsx)("p",{className:"text-sm text-default-500 mt-1",children:Z.description||"暂无描述"})]}),(0,a.jsxs)("div",{className:"flex gap-2",children:[(0,a.jsx)(u.A,{color:"primary",variant:"flat",startContent:(0,a.jsx)(z.Z,{className:"h-4 w-4"}),onPress:()=>{em(Z),eb({name:Z.name,description:Z.description}),ea()},size:"sm",children:"编辑"}),Z.owner_id!==(null==eS?void 0:eS.id)&&(0,a.jsx)(u.A,{color:"default",variant:"flat",onPress:()=>{if(Z&&eS&&confirm("确定要退出 ".concat(Z.name," 家庭吗？退出后将无法访问该家庭的数据。"))){if(Z.owner_id===eS.id){eI("您是家庭创建者，不能退出家庭。如需解散家庭，请使用解散功能。","error");return}ee({familyId:Z.id,memberId:eS.id})}},size:"sm",children:"退出家庭"}),Z.owner_id===(null==eS?void 0:eS.id)&&(0,a.jsx)(u.A,{color:"danger",variant:"flat",onPress:()=>{if(Z&&eS&&confirm("确定要解散 ".concat(Z.name," 家庭吗？解散后所有数据将被删除，此操作不可撤销。"))){if(Z.owner_id!==eS.id){eI("只有家庭创建者才能解散家庭","error");return}V(Z.id)}},size:"sm",children:"解散家庭"}),(0,a.jsx)(u.A,{color:"danger",variant:"flat",startContent:(0,a.jsx)(O.Z,{className:"h-4 w-4"}),onPress:()=>eJ(Z),size:"sm",isDisabled:Z.owner_id!==(null==eS?void 0:eS.id),children:"删除"}),(0,a.jsx)(u.A,{color:"primary",startContent:(0,a.jsx)(C,{className:"h-4 w-4"}),onPress:()=>{ez(null),ew({email:"",role:"member",isGeneric:!1,expiresInHours:48,maxUses:1}),eo()},size:"sm",isDisabled:!eQ,children:"添加成员"})]})]}),(0,a.jsxs)(l.n,{"aria-label":"家庭管理选项",selectedKey:eO,onSelectionChange:e=>eC(e),children:[(0,a.jsx)(c.r,{title:"成员管理",children:(0,a.jsx)("div",{className:"overflow-x-auto mt-4",children:(0,a.jsxs)(m.b,{"aria-label":"成员列表",classNames:{base:"min-w-full",table:"min-w-full",thead:"bg-default-50",th:"text-default-700 font-semibold",tr:"hover:bg-default-50 transition-colors border-b border-default-100"},children:[(0,a.jsxs)(h.J,{children:[(0,a.jsx)(x.j,{className:"text-sm",children:"用户名"}),(0,a.jsx)(x.j,{className:"text-sm",children:"邮箱"}),(0,a.jsx)(x.j,{className:"text-sm",children:"角色"}),(0,a.jsx)(x.j,{className:"text-sm",children:"操作"})]}),(0,a.jsx)(f.y,{items:s||[],emptyContent:"暂无成员，点击右上角添加",children:e=>(0,a.jsxs)(j.g,{className:"h-14",children:[(0,a.jsx)(p.X,{children:(0,a.jsx)("div",{className:"font-medium",children:e.name})}),(0,a.jsx)(p.X,{children:(0,a.jsx)("div",{className:"text-default-500",children:e.email})}),(0,a.jsx)(p.X,{children:(null==Z?void 0:Z.owner_id)===e.user_id?(0,a.jsx)(y.z,{color:"warning",variant:"flat",size:"sm",children:"创建者"}):"admin"===e.role?(0,a.jsx)(y.z,{color:"primary",variant:"flat",size:"sm",children:"管理员"}):(0,a.jsx)(y.z,{color:"default",variant:"flat",size:"sm",children:"成员"})}),(0,a.jsx)(p.X,{children:(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(null==Z?void 0:Z.owner_id)!==e.user_id&&(null==Z?void 0:Z.owner_id)===(null==eS?void 0:eS.id)&&(0,a.jsxs)(v.g,{"aria-label":"修改角色",selectedKeys:[e.role],onChange:s=>eV(e.id,s.target.value),size:"sm",className:"max-w-[120px]",children:[(0,a.jsx)(g.R,{value:"admin",children:"管理员"},"admin"),(0,a.jsx)(g.R,{value:"member",children:"成员"},"member")]}),(0,a.jsx)(u.A,{isIconOnly:!0,size:"sm",color:"danger",variant:"light",onPress:()=>eB(e),isDisabled:(null==Z?void 0:Z.owner_id)===e.user_id||(null==Z?void 0:Z.owner_id)!==(null==eS?void 0:eS.id),className:"rounded-full",children:(0,a.jsx)(O.Z,{className:"h-4 w-4"})})]})})]},e.id)})]})})},"members"),(0,a.jsx)(c.r,{title:"邀请管理",children:(0,a.jsx)("div",{className:"mt-4",children:Q?(0,a.jsx)(i.X,{className:"h-64"}):(0,a.jsx)(Y.Z,{invitations:X||[],type:"sent",onDelete:eQ?e=>{Z&&es({familyId:Z.id,invitationId:e})}:void 0})})},"invitations"),(0,a.jsx)(c.r,{title:"角色权限",children:(0,a.jsx)("div",{className:"mt-4",children:(0,a.jsx)(o.w,{children:(0,a.jsx)(d.G,{children:(0,a.jsxs)("div",{className:"space-y-6",children:[(0,a.jsxs)("div",{className:"flex justify-between items-center",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("h3",{className:"text-lg font-semibold",children:"角色权限设置"}),(0,a.jsx)("p",{className:"text-sm text-default-500",children:"管理家庭成员的角色和权限"})]}),eQ&&(0,a.jsx)(u.A,{color:"primary",size:"sm",startContent:(0,a.jsx)(E.Z,{className:"h-4 w-4"}),onPress:()=>{eM(void 0),eY()},children:"添加角色"})]}),eq?(0,a.jsxs)("div",{className:"space-y-4",children:[(0,a.jsx)(i.X,{className:"h-16 rounded-lg"}),(0,a.jsx)(i.X,{className:"h-16 rounded-lg"}),(0,a.jsx)(i.X,{className:"h-16 rounded-lg"})]}):(0,a.jsx)("div",{className:"space-y-4",children:null==eL?void 0:eL.map(e=>(0,a.jsxs)("div",{className:"border rounded-lg p-4",children:[(0,a.jsxs)("div",{className:"flex justify-between items-start mb-3",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("h4",{className:"font-medium",children:e.name}),(0,a.jsx)("p",{className:"text-sm text-default-500",children:e.description})]}),eQ&&!e.isSystem&&(0,a.jsxs)("div",{className:"flex gap-2",children:[(0,a.jsx)(u.A,{isIconOnly:!0,size:"sm",variant:"light",color:"primary",onPress:()=>e0(e),className:"rounded-full",children:(0,a.jsx)(z.Z,{className:"h-4 w-4"})}),(0,a.jsx)(u.A,{isIconOnly:!0,size:"sm",variant:"light",color:"danger",onPress:()=>e4(e),className:"rounded-full",children:(0,a.jsx)(O.Z,{className:"h-4 w-4"})})]})]}),(0,a.jsx)("div",{className:"grid grid-cols-2 md:grid-cols-3 gap-3",children:e.permissions.map(s=>(0,a.jsx)(y.z,{color:e.isSystem?"warning":"primary",variant:"flat",size:"sm",children:s.name},s.code))})]},e.id))})]})})})})},"roles"),(0,a.jsx)(c.r,{title:"家庭设置",children:(0,a.jsx)("div",{className:"mt-4",children:(0,a.jsx)(o.w,{children:(0,a.jsx)(d.G,{children:(0,a.jsxs)("div",{className:"space-y-6",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("h3",{className:"text-lg font-semibold",children:"基本设置"}),(0,a.jsxs)("div",{className:"mt-4 space-y-4",children:[(0,a.jsx)(b.Y,{label:"家庭名称",value:eg.name,onChange:e=>eb({...eg,name:e.target.value}),variant:"bordered",isDisabled:!eQ}),(0,a.jsx)(b.Y,{label:"家庭描述",value:eg.description,onChange:e=>eb({...eg,description:e.target.value}),variant:"bordered",isDisabled:!eQ})]})]}),(0,a.jsx)(N.j,{}),(0,a.jsxs)("div",{children:[(0,a.jsx)("h3",{className:"text-lg font-semibold",children:"账本设置"}),(0,a.jsxs)("div",{className:"mt-4 space-y-4",children:[(0,a.jsxs)("div",{className:"flex justify-between items-center",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("p",{className:"font-medium",children:"默认共享账本"}),(0,a.jsx)("p",{className:"text-sm text-default-500",children:"新成员加入时自动共享的账本"})]}),(0,a.jsx)(w.i,{isSelected:ej.defaultSharedBooks,onValueChange:e=>eU("defaultSharedBooks",e),isDisabled:!eQ})]}),(0,a.jsxs)("div",{className:"flex justify-between items-center",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("p",{className:"font-medium",children:"支出限额提醒"}),(0,a.jsx)("p",{className:"text-sm text-default-500",children:"成员超出支出限额时发送提醒"})]}),(0,a.jsx)(w.i,{isSelected:ej.expenseLimitAlert,onValueChange:e=>eU("expenseLimitAlert",e),isDisabled:!eQ})]})]})]}),(0,a.jsx)(N.j,{}),(0,a.jsxs)("div",{children:[(0,a.jsx)("h3",{className:"text-lg font-semibold",children:"通知设置"}),(0,a.jsxs)("div",{className:"mt-4 space-y-4",children:[(0,a.jsxs)("div",{className:"flex justify-between items-center",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("p",{className:"font-medium",children:"新成员加入通知"}),(0,a.jsx)("p",{className:"text-sm text-default-500",children:"有新成员加入时通知所有成员"})]}),(0,a.jsx)(w.i,{isSelected:ej.newMemberNotification,onValueChange:e=>eU("newMemberNotification",e),isDisabled:!eQ})]}),(0,a.jsxs)("div",{className:"flex justify-between items-center",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("p",{className:"font-medium",children:"大额支出通知"}),(0,a.jsx)("p",{className:"text-sm text-default-500",children:"发生大额支出时通知管理员"})]}),(0,a.jsx)(w.i,{isSelected:ej.largeExpenseNotification,onValueChange:e=>eU("largeExpenseNotification",e),isDisabled:!eQ})]}),(0,a.jsxs)("div",{className:"flex justify-between items-center",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("p",{className:"font-medium",children:"预算超支通知"}),(0,a.jsx)("p",{className:"text-sm text-default-500",children:"预算超支时通知相关成员"})]}),(0,a.jsx)(w.i,{isSelected:ej.budgetOverspendingNotification,onValueChange:e=>eU("budgetOverspendingNotification",e),isDisabled:!eQ})]})]})]}),eQ&&(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(N.j,{}),(0,a.jsx)("div",{className:"flex justify-end",children:(0,a.jsx)(u.A,{color:"primary",startContent:(0,a.jsx)(D.Z,{className:"h-4 w-4"}),onPress:()=>{Z&&ef(ej)},isLoading:ex,children:"保存设置"})})]})]})})})})},"settings")]})]})})]},"families"),(0,a.jsx)(c.r,{title:"我的邀请",children:(0,a.jsx)(o.w,{className:"shadow-sm hover:shadow-md transition-shadow duration-200",children:(0,a.jsxs)(d.G,{className:"p-6",children:[(0,a.jsx)("div",{className:"flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6",children:(0,a.jsxs)("div",{children:[(0,a.jsx)("h2",{className:"text-2xl font-bold text-primary",children:"我的邀请"}),(0,a.jsx)("p",{className:"text-sm text-default-500 mt-1",children:"查看所有收到的和发出的邀请"})]})}),(0,a.jsxs)(l.n,{children:[(0,a.jsx)(c.r,{title:"收到的邀请",children:(0,a.jsx)("div",{className:"mt-4",children:eA?(0,a.jsx)(i.X,{className:"h-64"}):eP&&eP.length>0?(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)("div",{className:"mb-4",children:(0,a.jsxs)("p",{className:"text-sm text-default-500",children:["您有 ",eP.length," 个待处理的邀请，请选择接受或拒绝"]})}),(0,a.jsx)(o.w,{className:"shadow-sm",children:(0,a.jsx)(d.G,{children:(0,a.jsx)(Y.Z,{invitations:eP,type:"received",onAccept:eW,onReject:e$})})})]}):(0,a.jsx)(o.w,{children:(0,a.jsxs)(d.G,{className:"py-8 text-center",children:[(0,a.jsx)("div",{className:"text-default-400 mb-2",children:(0,a.jsx)(k.Z,{className:"h-12 w-12 mx-auto"})}),(0,a.jsx)("p",{className:"text-default-600",children:"暂无收到的邀请"}),(0,a.jsx)(u.A,{color:"primary",variant:"light",size:"sm",className:"mt-4",onPress:()=>eT(),children:"刷新"})]})})})},"received"),(0,a.jsx)(c.r,{title:"发出的邀请",children:(0,a.jsx)("div",{className:"mt-4",children:(0,a.jsx)(o.w,{children:(0,a.jsxs)(d.G,{className:"py-4",children:[(0,a.jsx)("p",{className:"text-default-600 mb-4",children:"选择一个家庭查看已发送的邀请："}),(0,a.jsx)(v.g,{label:"选择家庭",placeholder:"请选择家庭",className:"max-w-xs mb-4",onChange:s=>{let t=parseInt(s.target.value),a=null==e?void 0:e.find(e=>e.id===t);a&&(M(a),eD("families"),eC("invitations"))},children:(e||[]).map(e=>(0,a.jsx)(g.R,{value:e.id,children:e.name},e.id))})]})})})},"sent")]})]})})},"invitations")]}),(0,a.jsx)(I.R,{isOpen:et,onClose:en,classNames:{base:"max-w-md mx-auto",header:"border-b border-default-100 pb-2",body:"py-6",footer:"border-t border-default-100 pt-2"},backdrop:"blur",children:(0,a.jsxs)(S.A,{children:[(0,a.jsxs)(P.k,{className:"flex flex-col gap-1",children:[(0,a.jsx)("h3",{className:"text-xl font-bold",children:eu?"编辑家庭":"创建家庭"}),(0,a.jsx)("p",{className:"text-sm text-default-500",children:eu?"修改家庭信息":"创建新的家庭"})]}),(0,a.jsx)(A.I,{children:(0,a.jsxs)("div",{className:"space-y-6",children:[(0,a.jsx)(b.Y,{label:"名称",placeholder:"请输入家庭名称",value:eg.name,onChange:e=>eb({...eg,name:e.target.value}),variant:"bordered",labelPlacement:"outside",isRequired:!0,startContent:(0,a.jsx)("div",{className:"pointer-events-none flex items-center",children:(0,a.jsx)("span",{className:"text-default-400 text-sm",children:"名称"})})}),(0,a.jsx)(b.Y,{label:"描述",placeholder:"请输入家庭描述",value:eg.description,onChange:e=>eb({...eg,description:e.target.value}),variant:"bordered",labelPlacement:"outside",startContent:(0,a.jsx)("div",{className:"pointer-events-none flex items-center",children:(0,a.jsx)("span",{className:"text-default-400 text-sm",children:"描述"})})})]})}),(0,a.jsxs)(T.R,{children:[(0,a.jsx)(u.A,{variant:"bordered",onPress:en,className:"min-w-[80px]",children:"取消"}),(0,a.jsx)(u.A,{color:"primary",onPress:()=>{if(!eg.name){eI("请填写家庭名称","error");return}eu?J({familyId:eu.id,data:eg}):U(eg),en(),em(null),eb({name:"",description:""})},className:"min-w-[80px]",children:"确定"})]})]})}),(0,a.jsx)(I.R,{isOpen:ec,onClose:ed,classNames:{base:"max-w-md mx-auto",header:"border-b border-default-100 pb-2",body:"py-6",footer:"border-t border-default-100 pt-2"},backdrop:"blur",children:(0,a.jsxs)(S.A,{children:[(0,a.jsxs)(P.k,{className:"flex flex-col gap-1",children:[(0,a.jsx)("h3",{className:"text-xl font-bold",children:"添加成员"}),(0,a.jsx)("p",{className:"text-sm text-default-500",children:eN.isGeneric?"创建通用邀请链接":"发送邀请给指定用户"})]}),(0,a.jsx)(A.I,{children:eE?(0,a.jsxs)("div",{className:"space-y-6",children:[(0,a.jsxs)("div",{className:"bg-success-50 p-4 rounded-lg text-center",children:[(0,a.jsx)("div",{className:"text-success text-xl mb-2",children:"✓"}),(0,a.jsx)("p",{className:"font-medium",children:"邀请已创建"}),(0,a.jsx)("p",{className:"text-sm text-default-500 mt-1",children:eN.isGeneric?"请将以下链接分享给需要加入的成员":"请将以下链接发送给 ".concat(eN.email)})]}),(0,a.jsx)("div",{className:"border border-default-200 rounded-lg p-3 bg-default-50",children:(0,a.jsx)("p",{className:"text-sm break-all",children:eE})}),(0,a.jsxs)("p",{className:"text-sm text-default-500",children:["邀请链接有效期为",eN.expiresInHours,"小时",eN.isGeneric?"，最多可被使用".concat(eN.maxUses,"次"):"","。",!eN.isGeneric&&"对方需要登录后才能接受邀请。"]})]}):(0,a.jsxs)("div",{className:"space-y-4",children:[(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsx)(w.i,{isSelected:eN.isGeneric,onValueChange:e=>ew({...eN,isGeneric:e})}),(0,a.jsx)("span",{children:"创建通用邀请链接（无需指定邮箱）"})]}),!eN.isGeneric&&(0,a.jsx)(b.Y,{label:"邮箱",placeholder:"请输入邮箱",value:eN.email,onValueChange:e=>ew({...eN,email:e})}),(0,a.jsxs)(v.g,{label:"角色",selectedKeys:[eN.role],onChange:e=>ew({...eN,role:e.target.value}),children:[(0,a.jsx)(g.R,{value:"member",children:"成员"},"member"),(0,a.jsx)(g.R,{value:"admin",children:"管理员"},"admin")]}),(0,a.jsx)(b.Y,{type:"number",label:"有效期（小时）",placeholder:"请输入有效期",value:eN.expiresInHours.toString(),onValueChange:e=>ew({...eN,expiresInHours:parseInt(e)||48})}),eN.isGeneric&&(0,a.jsx)(b.Y,{type:"number",label:"最大使用次数",placeholder:"请输入最大使用次数",value:eN.maxUses.toString(),onValueChange:e=>ew({...eN,maxUses:parseInt(e)||1}),description:"设置为1表示只能使用一次，设置更大的值可以多次使用"})]})}),(0,a.jsx)(T.R,{children:eE?(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(u.A,{color:"primary",variant:"light",onPress:()=>{navigator.clipboard.writeText(eE),eI("邀请链接已复制到剪贴板","success")},children:"复制链接"}),(0,a.jsx)(u.A,{color:"primary",onPress:()=>{ez(null),ed(),ew({email:"",role:"member",isGeneric:!1,expiresInHours:48,maxUses:1})},children:"完成"})]}):(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(u.A,{color:"danger",variant:"light",onPress:ed,children:"取消"}),(0,a.jsx)(u.A,{color:"primary",onPress:()=>{if(Z){if(!eN.isGeneric&&!eN.email){eI("请输入邮箱","error");return}B({familyId:Z.id,data:{email:eN.email,role:eN.role}},{onSuccess:e=>{e&&e.inviteLink?ez(e.inviteLink):(ed(),ew({email:"",role:"member",isGeneric:!1,expiresInHours:48,maxUses:1}))}})}},children:"创建邀请"})]})})]})}),(0,a.jsx)(I.R,{isOpen:er,onClose:el,classNames:{base:"max-w-md mx-auto",header:"border-b border-default-100 pb-2",body:"py-6",footer:"border-t border-default-100 pt-2"},backdrop:"blur",children:(0,a.jsxs)(S.A,{children:[(0,a.jsxs)(P.k,{className:"flex flex-col gap-1",children:[(0,a.jsx)("h3",{className:"text-xl font-bold",children:"确认删除"}),(0,a.jsx)("p",{className:"text-sm text-default-500",children:"此操作不可撤销"})]}),(0,a.jsxs)(A.I,{children:[(0,a.jsx)("div",{className:"flex items-center justify-center py-4",children:(0,a.jsx)("div",{className:"bg-danger-50 p-4 rounded-full mb-4",children:(0,a.jsx)(O.Z,{className:"h-8 w-8 text-danger"})})}),(0,a.jsx)("p",{className:"text-center",children:eu?(0,a.jsxs)(a.Fragment,{children:["确定要删除 ",(0,a.jsx)("span",{className:"font-bold",children:eu.name})," 家庭吗？"]}):(0,a.jsxs)(a.Fragment,{children:["确定要移除 ",(0,a.jsx)("span",{className:"font-bold",children:null==ey?void 0:ey.name})," 成员吗？"]})}),(0,a.jsx)("p",{className:"text-center text-default-500 text-sm mt-2",children:eu?"删除后所有相关数据将无法恢复。":"移除后该成员将无法访问此家庭的数据。"})]}),(0,a.jsxs)(T.R,{children:[(0,a.jsx)(u.A,{variant:"bordered",onPress:el,className:"min-w-[80px]",children:"取消"}),(0,a.jsx)(u.A,{color:"danger",onPress:eu?()=>{eu&&V(eu.id),el(),em(null)}:()=>{ey&&Z&&(console.log("确认移除成员:",ey,"家庭ID:",Z.id),ee({familyId:Z.id,memberId:ey.user_id}),el(),ev(null))},className:"min-w-[80px]",children:"删除"})]})]})}),(0,a.jsx)(H,{isOpen:eH,onClose:eX,onSubmit:e=>{eZ?eR({roleId:eZ.id,data:{name:e.name,description:e.description,permissions:e.permissions.map(e=>{var s,t;return{id:0,code:e,name:(null==eF?void 0:null===(s=eF.find(s=>s.code===e))||void 0===s?void 0:s.name)||"",description:(null==eF?void 0:null===(t=eF.find(s=>s.code===e))||void 0===t?void 0:t.description)||""}})}}):eG(e),eX()},role:eZ,permissions:eF,isLoading:eq})]})}},56732:function(e,s,t){"use strict";t.d(s,{Z:function(){return N}});var a=t(3827),n=t(64090),r=t(49977),i=t(96840),l=t(59584),c=t(10732),o=t(67945),d=t(51055),u=t(50535),m=t(75129),h=t(63053),x=t(77058),f=t(36685),j=t(92339),p=t(67474),y=t(72688),v=t(24424),g=t(62707),b=t(96770);function N(e){let{invitations:s,type:t,onAccept:N,onReject:w,onDelete:I}=e,{showToast:S}=(0,b.useToast)(),[P,A]=(0,n.useState)(null),T=e=>{let s="".concat(window.location.origin,"/invite/").concat(e);navigator.clipboard.writeText(s).then(()=>{S("邀请链接已复制到剪贴板","success")}).catch(()=>{S("复制失败，请手动复制","error")})},E=e=>new Date(e).toLocaleString(),z=e=>new Date(e)<new Date,O=e=>{let s=new Date,t=new Date(e).getTime()-s.getTime();if(t<=0)return"已过期";let a=Math.floor(t/864e5),n=Math.floor(t%864e5/36e5);return a>0?"".concat(a,"天").concat(n,"小时"):"".concat(n,"小时")},C=e=>{let{status:s,expires_at:t,max_uses:n,current_uses:c}=e;if("pending"===s&&z(t)||"expired"===s)return(0,a.jsx)(r.z,{color:"default",variant:"flat",size:"sm",children:"已过期"});switch(s){case"pending":if(n&&n>1){let e=n-(c||0);return(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsx)(r.z,{color:"warning",variant:"flat",size:"sm",children:"待处理"}),(0,a.jsx)(i.O,{content:"".concat(e,"/").concat(n),color:"primary",size:"sm",children:(0,a.jsx)(l.e,{content:"最多可使用".concat(n,"次，已使用").concat(c||0,"次，剩余").concat(e,"次"),children:(0,a.jsx)(p.Z,{className:"h-4 w-4 text-primary cursor-help"})})})]})}return(0,a.jsx)(r.z,{color:"warning",variant:"flat",size:"sm",children:"待处理"});case"accepted":if(n&&n>1){let e=n-(c||0);if(e>0)return(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsx)(r.z,{color:"success",variant:"flat",size:"sm",children:"已接受"}),(0,a.jsx)(i.O,{content:"".concat(e,"/").concat(n),color:"primary",size:"sm",children:(0,a.jsx)(l.e,{content:"最多可使用".concat(n,"次，已使用").concat(c||0,"次，还可使用").concat(e,"次"),children:(0,a.jsx)(p.Z,{className:"h-4 w-4 text-primary cursor-help"})})})]});return(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsx)(r.z,{color:"success",variant:"flat",size:"sm",children:"已接受"}),(0,a.jsx)(r.z,{color:"default",variant:"flat",size:"sm",children:"已用完"})]})}return(0,a.jsx)(r.z,{color:"success",variant:"flat",size:"sm",children:"已接受"});case"rejected":if(n&&n>1){let e=n-(c||0);if(e>0)return(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsx)(r.z,{color:"danger",variant:"flat",size:"sm",children:"已拒绝"}),(0,a.jsx)(i.O,{content:"".concat(e,"/").concat(n),color:"primary",size:"sm",children:(0,a.jsx)(l.e,{content:"最多可使用".concat(n,"次，已使用").concat(c||0,"次，还可使用").concat(e,"次"),children:(0,a.jsx)(p.Z,{className:"h-4 w-4 text-primary cursor-help"})})})]});return(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsx)(r.z,{color:"danger",variant:"flat",size:"sm",children:"已拒绝"}),(0,a.jsx)(r.z,{color:"default",variant:"flat",size:"sm",children:"已用完"})]})}return(0,a.jsx)(r.z,{color:"danger",variant:"flat",size:"sm",children:"已拒绝"});default:return null}},k=async(e,s)=>{if(N){A(s);try{await N(e)}finally{A(null)}}},D=async(e,s)=>{if(w){A(s);try{await w(e)}finally{A(null)}}},_=async e=>{if(I&&confirm("确定要删除此邀请吗？")){A(e);try{await I(e)}finally{A(null)}}},L=(0,n.useMemo)(()=>"sent"===t?[{key:"recipient",label:"接收者"},{key:"role",label:"角色"},{key:"status",label:"状态"},{key:"usage",label:"使用次数"},{key:"created_at",label:"创建时间"},{key:"expires_at",label:"有效期"},{key:"actions",label:"操作"}]:[{key:"family",label:"家庭"},{key:"creator",label:"邀请人"},{key:"role",label:"角色"},{key:"expires_at",label:"有效期"},{key:"actions",label:"操作"}],[t]),F=(e,s)=>{switch(console.log("渲染单元格: ".concat(s),e),s){case"recipient":return(0,a.jsx)("div",{className:"font-medium",children:e.is_generic||!e.email?(0,a.jsx)(r.z,{color:"secondary",variant:"flat",size:"sm",children:"通用邀请"}):e.email.replace(/(.{2})(.*)(@.*)/,"$1****$3")});case"family":return(0,a.jsxs)("div",{className:"font-medium",children:[e.family_name,e.is_generic&&(0,a.jsx)(r.z,{color:"secondary",variant:"flat",size:"sm",className:"ml-2",children:"通用邀请"})]});case"creator":return(0,a.jsxs)("div",{className:"text-default-500",children:[e.creator_name,e.max_uses&&e.max_uses>1&&(0,a.jsxs)("div",{className:"text-xs mt-1",children:["可使用",e.max_uses,"次，已使用",e.current_uses||0,"次"]})]});case"role":return(0,a.jsx)(r.z,{color:"admin"===e.role?"primary":"default",variant:"flat",size:"sm",children:"admin"===e.role?"管理员":"成员"});case"status":return C(e);case"usage":console.log("渲染使用次数:",e.max_uses,e.current_uses);let n=e.max_uses||1,o=e.current_uses||0,d=n-o;return(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsxs)("div",{className:"text-default-500 text-sm",children:[o,"/",n]}),n>1&&(0,a.jsx)(l.e,{content:"最多可使用".concat(n,"次，已使用").concat(o,"次，剩余").concat(d,"次"),children:(0,a.jsx)(i.O,{content:"".concat(d),color:"primary",size:"sm",children:(0,a.jsx)(p.Z,{className:"h-4 w-4 text-default-400 cursor-help"})})})]});case"created_at":return(0,a.jsx)("div",{className:"text-default-500 text-sm",children:E(e.created_at)});case"expires_at":return(0,a.jsxs)("div",{className:"text-default-500 text-sm",children:[(0,a.jsx)("div",{children:E(e.expires_at)}),(0,a.jsx)("div",{className:"text-xs mt-1",children:"pending"===e.status?"剩余: ".concat(O(e.expires_at)):""})]});case"actions":if("sent"===t)return(0,a.jsxs)("div",{className:"flex items-center gap-2",children:["pending"===e.status&&!z(e.expires_at)&&(0,a.jsx)(l.e,{content:"复制邀请链接",children:(0,a.jsx)(c.A,{isIconOnly:!0,size:"sm",variant:"light",onPress:()=>T(e.token),children:(0,a.jsx)(y.Z,{className:"h-4 w-4"})})}),(e.is_generic||!e.email)&&!z(e.expires_at)&&"pending"!==e.status&&(0,a.jsx)(l.e,{content:"复制邀请链接",children:(0,a.jsx)(c.A,{isIconOnly:!0,size:"sm",variant:"light",onPress:()=>T(e.token),children:(0,a.jsx)(y.Z,{className:"h-4 w-4"})})}),I&&(0,a.jsx)(l.e,{content:"删除邀请",children:(0,a.jsx)(c.A,{isIconOnly:!0,size:"sm",color:"danger",variant:"light",onPress:()=>_(e.id),isDisabled:P===e.id,children:(0,a.jsx)(v.Z,{className:"h-4 w-4"})})})]});return(0,a.jsx)("div",{className:"flex items-center gap-2",children:"pending"===e.status&&!z(e.expires_at)&&(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(c.A,{size:"sm",color:"danger",variant:"flat",onPress:()=>D(e.token,e.id),isDisabled:P===e.id,children:"拒绝"}),(0,a.jsx)(c.A,{size:"sm",color:"primary",onPress:()=>k(e.token,e.id),isDisabled:P===e.id,isLoading:P===e.id,children:"接受"})]})});default:return null}};return 0===s.length?(0,a.jsx)(o.w,{children:(0,a.jsxs)(d.G,{className:"py-8 text-center",children:[(0,a.jsx)("div",{className:"text-default-400 mb-2",children:(0,a.jsx)(g.Z,{className:"h-12 w-12 mx-auto"})}),(0,a.jsx)("p",{className:"text-default-600",children:"sent"===t?"暂无已发送的邀请":"暂无收到的邀请"})]})}):(0,a.jsx)("div",{className:"overflow-x-auto",children:(0,a.jsxs)(u.b,{"aria-label":"sent"===t?"已发送的邀请":"收到的邀请",classNames:{base:"min-w-full",table:"min-w-full",thead:"bg-default-50",th:"text-default-700 font-semibold",tr:"hover:bg-default-50 transition-colors border-b border-default-100"},children:[(0,a.jsx)(m.J,{columns:L,children:e=>(0,a.jsx)(h.j,{className:"text-sm",children:e.label},e.key)}),(0,a.jsx)(x.y,{items:s,emptyContent:"暂无邀请",children:e=>(console.log("渲染行:",e),(0,a.jsx)(f.g,{className:"h-14",children:s=>(console.log("渲染列:",s.toString()),(0,a.jsx)(j.X,{children:F(e,s.toString())}))},e.id))})]})})}},96770:function(e,s,t){"use strict";t.r(s),t.d(s,{ToastProvider:function(){return c},useToast:function(){return l}});var a=t(3827),n=t(64090),r=t(10963);let i=(0,n.createContext)(void 0);function l(){let e=(0,n.useContext)(i);if(!e)throw Error("useToast must be used within a ToastProvider");return e}function c(e){let{children:s}=e;return(0,a.jsxs)(i.Provider,{value:{showToast:function(e){let s=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"info",t={duration:3e3,style:{padding:"16px",borderRadius:"8px"}};switch(s){case"success":r.Am.success(e,t);break;case"error":r.Am.error(e,t);break;case"warning":(0,r.Am)(e,{...t,icon:"⚠️"});break;default:(0,r.Am)(e,{...t,icon:"ℹ️"})}}},children:[s,(0,a.jsx)(r.x7,{position:"top-center"})]})}},26632:function(e,s,t){"use strict";t.d(s,{AW:function(){return r},Kz:function(){return n},P8:function(){return i}});var a=t(77785);let n={[a.Yt.DASHBOARD]:{component:()=>Promise.all([t.e(7674),t.e(6034),t.e(9390),t.e(9689),t.e(7945),t.e(7530),t.e(5784),t.e(9178),t.e(7385),t.e(3614),t.e(6288),t.e(4187),t.e(224),t.e(1945),t.e(8704),t.e(414),t.e(4322),t.e(5961),t.e(4642),t.e(4788),t.e(568),t.e(6373),t.e(8792),t.e(5769),t.e(3509),t.e(2132),t.e(9430),t.e(3135),t.e(3735),t.e(5626),t.e(7294),t.e(2751),t.e(4103),t.e(7923),t.e(8026)]).then(t.bind(t,27923)).then(e=>e.default),permission:a.wI.PRIVATE,layout:()=>Promise.all([t.e(9390),t.e(9178),t.e(3614),t.e(7108)]).then(t.bind(t,17108)).then(e=>e.default)},[a.Yt.TRANSACTIONS]:{component:()=>Promise.all([t.e(6034),t.e(9390),t.e(9689),t.e(7945),t.e(7530),t.e(5784),t.e(7385),t.e(6288),t.e(4187),t.e(224),t.e(1945),t.e(8704),t.e(414),t.e(4322),t.e(5961),t.e(4788),t.e(568),t.e(3509),t.e(3735),t.e(3121),t.e(2751),t.e(1731)]).then(t.bind(t,47646)).then(e=>e.default),permission:a.wI.FAMILY,layout:()=>Promise.all([t.e(6034),t.e(9390),t.e(9689),t.e(7945),t.e(7530),t.e(9178),t.e(3614),t.e(6288),t.e(3121),t.e(3345)]).then(t.bind(t,33345)).then(e=>e.default)},[a.Yt.STATISTICS]:{component:()=>Promise.all([t.e(7674),t.e(6034),t.e(9390),t.e(9689),t.e(7945),t.e(7530),t.e(5784),t.e(9178),t.e(7385),t.e(3614),t.e(6288),t.e(4187),t.e(224),t.e(1945),t.e(8704),t.e(414),t.e(4322),t.e(5961),t.e(4642),t.e(4788),t.e(568),t.e(6373),t.e(8792),t.e(5769),t.e(3509),t.e(2132),t.e(3121),t.e(2751),t.e(4103),t.e(7641)]).then(t.bind(t,87641)).then(e=>e.default),permission:a.wI.FAMILY,layout:()=>Promise.all([t.e(6034),t.e(9390),t.e(9689),t.e(7945),t.e(7530),t.e(9178),t.e(3614),t.e(6288),t.e(3121),t.e(8891)]).then(t.bind(t,18891)).then(e=>e.default)},[a.Yt.SETTINGS]:{component:()=>Promise.all([t.e(6034),t.e(9390),t.e(9689),t.e(7945),t.e(1077)]).then(t.bind(t,1077)).then(e=>e.default),permission:a.wI.PRIVATE,layout:()=>Promise.all([t.e(6034),t.e(9390),t.e(9689),t.e(7945),t.e(9178),t.e(3614),t.e(8792),t.e(1207)]).then(t.bind(t,31207)).then(e=>e.default)},[a.Yt.CUSTOM]:{component:()=>Promise.all([t.e(6034),t.e(9390),t.e(9689),t.e(7945),t.e(6288),t.e(3121),t.e(7386)]).then(t.bind(t,7386)).then(e=>e.default),permission:a.wI.PRIVATE,layout:()=>Promise.all([t.e(6034),t.e(9390),t.e(9689),t.e(7945),t.e(7530),t.e(9178),t.e(3614),t.e(510)]).then(t.bind(t,20510)).then(e=>e.default)}};function r(e,s,t,r){switch(n[e],s){case a.wI.PUBLIC:return!0;case a.wI.PRIVATE:return!!t;case a.wI.FAMILY:case a.wI.ADMIN:return!!t&&!!r;default:return!1}}async function i(e,s){let t=n[s];if(!t)throw Error("未找到路由类型 ".concat(s," 对应的组件"));try{let e=await t.component(),s=t.layout?await t.layout():null;return{Component:e,Layout:s,permission:t.permission}}catch(e){throw console.error("加载路由组件失败: ".concat(e)),e}}},52131:function(e,s,t){"use strict";t.r(s),t.d(s,{AuthProvider:function(){return p},useAuth:function(){return y}});var a=t(3827),n=t(64090),r=t(47907),i=t(96770),l=t(58222),c=t(94564),o=t(37963),d=t(77785),u=t(26632);let m=async e=>{let s=await (0,l.Io)("/auth/login",{method:"POST",body:JSON.stringify(e)});return console.log("ssss",s),s.data},h=async e=>(await (0,l.Io)("/auth/register",{method:"POST",body:JSON.stringify(e)})).data,x=async e=>(await (0,l.Io)("/auth/verify-guest",{method:"POST",body:JSON.stringify({password:e})})).data,f=async e=>(await (0,l.Io)("/user/settings",{method:"PATCH",body:JSON.stringify(e)})).data,j=(0,n.createContext)(void 0);function p(e){let{children:s}=e,[t,l]=(0,n.useState)(null),[p,y]=(0,n.useState)(!1),[v,g]=(0,n.useState)(!1),b=(0,r.useRouter)(),{showToast:N}=(0,i.useToast)(),w=e=>{try{let s=(0,o.o)(e),t=Date.now()/1e3;if(s.exp&&s.exp<t)return(0,c.gy)(),localStorage.removeItem("isGuest"),null;return{id:s.id,username:s.username,email:s.email,role:s.role,privacy_mode:s.privacy_mode,default_route:s.default_route,permissions:s.permissions}}catch(e){return console.error("解析 token 失败:",e),(0,c.gy)(),localStorage.removeItem("isGuest"),null}},I=async e=>{if(!e||!e.default_route){b.push("/dashboard");return}try{let s=e.default_route,t=s.split("/")[1];if(!(0,u.AW)(t,d.wI.PRIVATE,"string"==typeof e.id?parseInt(e.id,10):e.id,e.currentFamilyId?"string"==typeof e.currentFamilyId?parseInt(e.currentFamilyId,10):e.currentFamilyId:void 0)){console.warn("用户无权访问默认路由，重定向到仪表盘"),b.push("/dashboard");return}await (0,u.P8)(s,t),b.push(s)}catch(e){console.error("路由导航失败:",e),b.push("/dashboard")}};(0,n.useEffect)(()=>{let e=(0,c.LP)(),s="true"===localStorage.getItem("isGuest"),t=window.location.pathname,a=t.startsWith("/auth/"),n="/"===t||"/about"===t;if(e){let t=w(e);t?(l(t),y(s),a&&I(t)):a||n||b.push("/auth/login")}else a||n||b.push("/auth/login")},[b]);let S=async(e,s)=>{try{let{token:t,user:a}=await m({email:e,password:s});(0,c.o4)(t),l(a),y(!1),localStorage.setItem("isGuest","false"),N("登录成功","success"),I(a)}catch(e){throw N("登录失败","error"),e}},P=async e=>{try{let{token:s,user:t}=await h(e);(0,c.o4)(s),l(t),y(!1),localStorage.setItem("isGuest","false"),N("注册成功","success"),I(t)}catch(e){throw N("注册失败","error"),e}},A=async e=>{try{await x(e),y(!0),localStorage.setItem("isGuest","true")}catch(e){throw e}},T=async e=>{try{let s=await f(e);return l(s),s}catch(e){throw e instanceof Error?N(e.message,"error"):N("更新设置失败","error"),e}};return(0,a.jsx)(j.Provider,{value:{user:t,isGuest:p,isLoading:v,setUser:l,updateUser:e=>{l(e)},updateSettings:T,login:S,register:P,logout:()=>{(0,c.gy)(),localStorage.removeItem("isGuest"),l(null),y(!1),b.push("/auth/login")},enterGuestMode:A,exitGuestMode:()=>{y(!1),localStorage.removeItem("isGuest")},handleUnauthorized:()=>{(0,c.gy)(),localStorage.removeItem("isGuest"),localStorage.removeItem("currentFamilyId"),l(null),y(!1),"/auth/login"!==window.location.pathname&&(N("登录已过期，请重新登录","error"),b.push("/auth/login"))}},children:s})}function y(){let e=(0,n.useContext)(j);if(void 0===e)throw Error("useAuth must be used within an AuthProvider");return e}},20003:function(e,s,t){"use strict";t.d(s,{Hc:function(){return f},Oh:function(){return x},X$:function(){return v},YF:function(){return h},ao:function(){return y},cW:function(){return d},kN:function(){return p},l0:function(){return u},t3:function(){return j},vP:function(){return m}});var a=t(47082),n=t(94642),r=t(20568),i=t(64090),l=t(58222),c=t(96770),o=t(52131);function d(){let{user:e,updateUser:s}=(0,o.useAuth)(),t=(0,a.NL)(),{showToast:r}=(0,c.useToast)(),[d,u]=(0,i.useState)([]),m=(0,i.useRef)(!1),{data:h,isLoading:x,error:f}=(0,n.a)({queryKey:["families"],queryFn:async()=>{try{let e=await (0,l.Io)("/families/user");return m.current=!1,e.data}catch(e){throw console.error("获取家庭列表失败:",e),m.current=!0,e}},enabled:!!e,staleTime:3e5,retry:m.current?0:2}),j=null==h?void 0:h.find(s=>s.id===(null==e?void 0:e.currentFamilyId)),{data:p,isLoading:y,error:v}=(0,n.a)({queryKey:["familyMembers",null==e?void 0:e.currentFamilyId],queryFn:async()=>(await (0,l.Io)("/families/".concat(null==e?void 0:e.currentFamilyId,"/members"))).data,enabled:!!(null==e?void 0:e.currentFamilyId)&&!m.current,staleTime:3e5,gcTime:3e5,retry:1});(0,i.useEffect)(()=>{f&&console.error("获取家庭列表失败:",f)},[f]),(0,i.useEffect)(()=>{v&&console.error("获取家庭成员失败:",v)},[v]);let g=(0,i.useCallback)(a=>{e&&(s({...e,currentFamilyId:a.id}),t.invalidateQueries({queryKey:["familyMembers"]}),t.invalidateQueries({queryKey:["transactions"]}),t.invalidateQueries({queryKey:["categories"]}),t.invalidateQueries({queryKey:["statistics"]}),t.invalidateQueries({queryKey:["categoryStats"]}),t.invalidateQueries({queryKey:["recentTransactions"]}),localStorage.setItem("currentFamilyId",a.id.toString()))},[e,s,t]),b=(0,i.useCallback)(()=>(null==j?void 0:j.owner_id)===(null==e?void 0:e.id)||(null==p?void 0:p.some(s=>s.user_id===(null==e?void 0:e.id)&&"admin"===s.role)),[j,e,p]);return{families:h,members:p||d,currentFamily:j,isLoading:x||y,error:f,setCurrentFamily:g,isAdmin:b}}function u(){let e=(0,a.NL)(),{showToast:s}=(0,c.useToast)();return(0,r.D)({mutationFn:async e=>(await (0,l.Io)("/families",{method:"POST",body:JSON.stringify(e)})).data,onSuccess:()=>{s("家庭创建成功","success"),e.invalidateQueries({queryKey:["families"]})},onError:e=>{s("创建失败: ".concat(e.message),"error")}})}function m(){let e=(0,a.NL)(),{showToast:s}=(0,c.useToast)();return(0,r.D)({mutationFn:async e=>{let{familyId:s,data:t}=e;return(await (0,l.Io)("/families/".concat(s),{method:"PATCH",body:JSON.stringify(t)})).data},onSuccess:()=>{s("家庭信息已更新","success"),e.invalidateQueries({queryKey:["families"]})},onError:e=>{s("更新失败: ".concat(e.message),"error")}})}function h(){let e=(0,a.NL)(),{showToast:s}=(0,c.useToast)();return(0,r.D)({mutationFn:async e=>{await (0,l.Io)("/families/".concat(e),{method:"DELETE"})},onSuccess:()=>{s("家庭已删除","success"),e.invalidateQueries({queryKey:["families"]})},onError:e=>{s("删除失败: ".concat(e.message),"error")}})}function x(){let e=(0,a.NL)(),{showToast:s}=(0,c.useToast)();return(0,r.D)({mutationFn:async e=>{let{familyId:s,data:t}=e;return(await (0,l.Io)("/families/".concat(s,"/members"),{method:"POST",body:JSON.stringify(t)})).data},onSuccess:()=>{s("成员已添加","success"),e.invalidateQueries({queryKey:["family"]})},onError:e=>{s("添加失败: ".concat(e.message),"error")}})}function f(){let e=(0,a.NL)(),{showToast:s}=(0,c.useToast)();return(0,r.D)({mutationFn:async e=>{let{familyId:s,memberId:t,role:a}=e;return(await (0,l.Io)("/families/".concat(s,"/members/").concat(t),{method:"PATCH",body:JSON.stringify({role:a})})).data},onSuccess:()=>{s("成员角色已更新","success"),e.invalidateQueries({queryKey:["family"]})},onError:e=>{s("更新失败: ".concat(e.message),"error")}})}function j(){let e=(0,a.NL)(),{showToast:s}=(0,c.useToast)();return(0,r.D)({mutationFn:async e=>{let{familyId:s,memberId:t}=e;await (0,l.Io)("/families/".concat(s,"/members/").concat(t),{method:"DELETE"})},onSuccess:()=>{s("成员已移除","success"),e.invalidateQueries({queryKey:["family"]})},onError:e=>{s("移除失败: ".concat(e.message),"error")}})}function p(e){return(0,n.a)({queryKey:["familyInvitations",e],queryFn:async()=>e?(await (0,l.Io)("/families/".concat(e,"/invitations"))).data:[],enabled:!!e})}function y(){let e=(0,a.NL)(),{showToast:s}=(0,c.useToast)();return(0,r.D)({mutationFn:async e=>{let{familyId:s,invitationId:t}=e;await (0,l.Io)("/families/".concat(s,"/invitations/").concat(t),{method:"DELETE"})},onSuccess:()=>{s("邀请已删除","success"),e.invalidateQueries({queryKey:["familyInvitations"]})},onError:e=>{s("删除失败: ".concat(e.message),"error")}})}function v(e){return(0,n.a)({queryKey:["userInvitations",e],queryFn:async()=>e&&(await (0,l.Io)("/users/".concat(e,"/invitations"))).data||[],enabled:!!e})}},58222:function(e,s,t){"use strict";t.d(s,{AW:function(){return I},Cp:function(){return E},Ds:function(){return x},Hb:function(){return c},Io:function(){return m},KX:function(){return j},Ml:function(){return A},Nq:function(){return S},R5:function(){return T},_c:function(){return y},dx:function(){return f},fM:function(){return w},fq:function(){return g},h8:function(){return P},hQ:function(){return o},le:function(){return p},ot:function(){return v},qW:function(){return b},rr:function(){return N},we:function(){return h}});var a=t(77785),n=t(94564);let r=t(49079).env.NEXT_PUBLIC_API_URL||"http://localhost:3001/api",i=null,l=null;function c(e){i=e}function o(e){l=e}function d(e){let s=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"error";l?l(e,s):console["error"===s?"error":"warning"===s?"warn":"log"](e)}let u={400:e=>{console.warn("请求参数错误: ".concat(e)),d("请求参数错误: ".concat(e),"warning")},401:e=>{(0,n.gy)(),localStorage.removeItem("isGuest"),localStorage.removeItem("currentFamilyId"),i?i():"/auth/login"!==window.location.pathname&&(d("登录已过期，请重新登录"+window.location.pathname,"error"),window.location.href="/auth/login")},403:e=>{console.warn("无权访问: ".concat(e)),d("无权访问: ".concat(e),"error")},404:e=>{console.warn("资源不存在: ".concat(e)),d("资源不存在: ".concat(e),"warning")},422:e=>{console.warn("数据验证失败: ".concat(e)),d("数据验证失败: ".concat(e),"warning")},429:e=>{console.warn("请求过多，请稍后再试: ".concat(e)),d("请求过多，请稍后再试","warning")},500:e=>{console.error("服务器错误: ".concat(e)),d("服务器内部错误，请稍后再试: ".concat(e),"error")},502:e=>{console.error("网关错误: ".concat(e)),d("服务器网关错误，请稍后再试","error")},503:e=>{console.error("服务不可用: ".concat(e)),d("服务暂时不可用，请稍后再试","error")},504:e=>{console.error("网关超时: ".concat(e)),d("请求超时，请检查网络连接后重试","error")}};async function m(e){let s=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},t="".concat(r).concat(e),i=(0,n.LP)(),l={"Content-Type":"application/json",...i?{Authorization:"Bearer ".concat(i)}:{}};try{let e=await fetch(t,{...s,headers:{...l,...s.headers}}),n=await e.json();if(console.log("sssssss",n),!e.ok){let s=u[e.status];throw s&&s(n.message||"请求失败"),new a.Hx(e.status,n.message||"请求失败")}return{data:n,message:n.message,status:e.status}}catch(e){if(e instanceof a.Hx)throw e;throw new a.Hx(500,e instanceof Error?e.message:"网络错误")}}let h=function(e){let s=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"请求失败";if(e instanceof a.Hx)switch(e.status){case 400:return"请求参数错误: ".concat(e.message);case 403:return"无权访问: ".concat(e.message);case 404:return"资源不存在: ".concat(e.message);case 429:return"请求过于频繁，请稍后再试";case 500:case 502:case 503:return"服务器错误: ".concat(e.message);default:return e.message||s}return(null==e?void 0:e.message)||s};async function x(e){return(await m("/routes/predictions?user_id=".concat(e),{method:"GET"})).data}async function f(e){return(await m("/routes/".concat(e,"/optimization"),{method:"GET"})).data}async function j(e){let s=new URLSearchParams;e.startDate&&s.append("startDate",e.startDate),e.endDate&&s.append("endDate",e.endDate),e.routeIds&&e.routeIds.length>0&&e.routeIds.forEach(e=>s.append("routeIds[]",e.toString()));let t="".concat(r,"/routes/export?").concat(s.toString(),"&format=").concat(e.format),i=(0,n.LP)(),l=await fetch(t,{method:"GET",headers:{...i?{Authorization:"Bearer ".concat(i)}:{}}});if(!l.ok){let e=await l.json();throw new a.Hx(l.status,e.message||"导出失败")}return await l.blob()}async function p(e){let s=new URLSearchParams;return s.append("type",e.type),e.startDate&&s.append("startDate",e.startDate),e.endDate&&s.append("endDate",e.endDate),e.routeIds&&e.routeIds.length>0&&e.routeIds.forEach(e=>s.append("routeIds[]",e.toString())),(await m("/routes/visualization?".concat(s.toString()),{method:"GET"})).data}async function y(){return m("/routes")}async function v(e){return m("/routes",{method:"POST",body:JSON.stringify(e)})}async function g(e,s){return m("/routes/".concat(e),{method:"PUT",body:JSON.stringify(s)})}async function b(e){return m("/routes/".concat(e),{method:"DELETE"})}async function N(e){return m("/routes/".concat(e,"/toggle"),{method:"POST"})}async function w(e){return m("/routes/".concat(e,"/stats"))}async function I(){return m("/users")}async function S(e,s){return m("/users/".concat(e),{method:"PUT",body:JSON.stringify(s)})}async function P(e){return m("/users/".concat(e),{method:"DELETE"})}async function A(e){return m("/users/".concat(e,"/freeze"),{method:"POST"})}async function T(e){return m("/users/".concat(e,"/unfreeze"),{method:"POST"})}async function E(e){return m("/auth/change-password",{method:"POST",body:JSON.stringify(e)})}},77785:function(e,s,t){"use strict";var a,n,r,i;t.d(s,{Hx:function(){return l},Yt:function(){return a},wI:function(){return n}});class l extends Error{constructor(e,s){super(s),this.status=e,this.name="APIError"}}(r=a||(a={})).DASHBOARD="dashboard",r.TRANSACTIONS="transactions",r.STATISTICS="statistics",r.SETTINGS="settings",r.CUSTOM="custom",(i=n||(n={})).PUBLIC="public",i.PRIVATE="private",i.FAMILY="family",i.ADMIN="admin"},94564:function(e,s,t){"use strict";function a(){return localStorage.getItem("token")}function n(e){localStorage.setItem("token",e)}function r(){localStorage.removeItem("token")}t.d(s,{LP:function(){return a},gy:function(){return r},o4:function(){return n}})},25548:function(e,s,t){"use strict";var a=t(64090);let n=a.forwardRef(function(e,s){let{title:t,titleId:n,...r}=e;return a.createElement("svg",Object.assign({xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",strokeWidth:1.5,stroke:"currentColor","aria-hidden":"true","data-slot":"icon",ref:s,"aria-labelledby":n},r),t?a.createElement("title",{id:n},t):null,a.createElement("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L6.832 19.82a4.5 4.5 0 0 1-1.897 1.13l-2.685.8.8-2.685a4.5 4.5 0 0 1 1.13-1.897L16.863 4.487Zm0 0L19.5 7.125"}))});s.Z=n},1310:function(e,s,t){"use strict";var a=t(64090);let n=a.forwardRef(function(e,s){let{title:t,titleId:n,...r}=e;return a.createElement("svg",Object.assign({xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",strokeWidth:1.5,stroke:"currentColor","aria-hidden":"true","data-slot":"icon",ref:s,"aria-labelledby":n},r),t?a.createElement("title",{id:n},t):null,a.createElement("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M12 4.5v15m7.5-7.5h-15"}))});s.Z=n}},function(e){e.O(0,[6034,9390,9689,7945,7530,2178,5784,9178,7385,3614,4187,224,1945,8704,414,4322,5961,4642,4788,568,6373,5769,9430,1493,2971,8069,1744],function(){return e(e.s=8672)}),_N_E=e.O()}]);