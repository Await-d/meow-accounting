"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[3121],{63121:function(e,t,a){a.r(t),a.d(t,{RouteProvider:function(){return k},useRoute:function(){return g}});var r=a(3827),l=a(64090),c=a(47907),n=a(52131),o=a(77785),s=a(58222),u=a(41310),i=a(26632);let d={[o.Yt.DASHBOARD]:1,[o.Yt.TRANSACTIONS]:2,[o.Yt.STATISTICS]:3,[o.Yt.SETTINGS]:4,[o.Yt.CUSTOM]:5},m={maxConcurrent:2,interval:5e3,timeout:1e4};function f(){let e=(0,l.useRef)(new Set),t=(0,l.useRef)(new Set),a=(0,l.useCallback)(e=>d[e.type]||1/0,[]),r=(0,l.useCallback)(e=>[...e].sort((e,t)=>a(e)-a(t)),[a]),c=(0,l.useCallback)(async a=>{if(!(e.current.has(a.path)||t.current.has(a.path))){e.current.add(a.path);try{let e=i.Kz[a.type];if(!e)return;let r=new Promise((e,t)=>{setTimeout(()=>t(Error("预热超时")),m.timeout)}),l=Promise.all([e.component(),e.layout?e.layout():Promise.resolve(null)]);await Promise.race([l,r]),t.current.add(a.path)}catch(e){console.warn("路由预热失败: ".concat(a.path),e)}finally{e.current.delete(a.path)}}},[]),n=(0,l.useCallback)(async e=>{let t=r(e),a=[];for(let e=0;e<t.length;e+=m.maxConcurrent)a.push(t.slice(e,e+m.maxConcurrent));for(let e of a)await Promise.all(e.map(e=>c(e))),a.indexOf(e)<a.length-1&&await new Promise(e=>setTimeout(e,m.interval))},[c,r]),o=(0,l.useCallback)(e=>t.current.has(e),[]),s=(0,l.useCallback)(()=>({preheating:Array.from(e.current),preheated:Array.from(t.current)}),[]),u=(0,l.useCallback)(()=>{e.current.clear(),t.current.clear()},[]);return(0,l.useEffect)(()=>()=>{u()},[u]),{preheatRoute:c,preheatRoutes:n,isRoutePreheated:o,getPreheatStatus:s,clearPreheatCache:u,getRoutePriority:a,sortRoutesByPriority:r}}let h={maxSize:5242880,maxAge:18e5,minPriority:3},C="route_params";var p=a(56288);let y=(0,l.createContext)(void 0);function b(e){let{children:t}=e,a=(0,c.useRouter)(),d=(0,c.usePathname)(),m=(0,c.useSearchParams)(),{user:b}=(0,n.useAuth)(),[k,g]=(0,l.useState)(),[S,w]=(0,l.useState)({}),[v,I]=(0,l.useState)([]),[A,P]=(0,l.useState)([]),[T,E]=(0,l.useState)(!1),[R,L]=(0,l.useState)(!1),{showToast:x}=(0,u.p)(),{getCachedRoute:O,cacheRoute:z,clearExpiredCache:F}=function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{maxSize:t,maxAge:a,minPriority:r}={...h,...e},[c,n]=(0,l.useState)(new Map),{getRoutePriority:o}=f(),s=(0,l.useRef)(0),u=(0,l.useCallback)(e=>JSON.stringify(e).length,[]),i=(0,l.useCallback)(e=>Date.now()-e.lastAccessed>a,[a]),d=(0,l.useCallback)(e=>o(e)<=r,[o,r]),m=(0,l.useCallback)(e=>{let t=c.get(e);return t?i(t)?(c.delete(e),s.current-=t.size,n(new Map(c)),null):(t.lastAccessed=Date.now(),n(new Map(c)),t):null},[c,i]),C=(0,l.useCallback)(e=>{let a=Array.from(c.entries());if(Date.now(),a.forEach(e=>{let[t,a]=e;i(a)&&(c.delete(t),s.current-=a.size)}),s.current+e>t)for(let[r,l]of a.filter(e=>{let[t,a]=e;return!i(a)}).sort((e,t)=>{let a=t[1].priority-e[1].priority;return 0!==a?a:e[1].lastAccessed-t[1].lastAccessed})){if(s.current+e<=t)break;c.delete(r),s.current-=l.size}n(new Map(c))},[c,i,t]);return{getCachedRoute:m,cacheRoute:(0,l.useCallback)(e=>{if(!d(e))return;let a=u(e),r=o(e);s.current+a>t&&C(a);let l={...e,lastAccessed:Date.now(),priority:r,size:a};c.set(e.path,l),s.current+=a,n(new Map(c))},[d,u,o,t,C,c]),clearExpiredCache:(0,l.useCallback)(()=>{let e=!1;c.forEach((t,a)=>{i(t)&&(c.delete(a),s.current-=t.size,e=!0)}),e&&n(new Map(c))},[c,i]),getCacheStats:(0,l.useCallback)(()=>({totalSize:s.current,itemCount:c.size,maxSize:t,usage:s.current/t*100}),[c,t])}}(),{preloadRoute:D,preloadRoutes:N}=function(){let e=(0,l.useCallback)(async e=>{try{let t=i.Kz[e.type];if(!t)return;let a=t.component(),r=t.layout?t.layout():Promise.resolve(null);await Promise.all([a,r])}catch(t){console.error("预加载路由失败: ".concat(e.path),t)}},[]),t=(0,l.useCallback)(async t=>{let a=t.map(t=>e(t));await Promise.allSettled(a)},[e]);return{preloadRoute:e,preloadRoutes:t,preloadRouteType:(0,l.useCallback)(async e=>{try{let t=i.Kz[e];if(!t)return;let a=t.component(),r=t.layout?t.layout():Promise.resolve(null);await Promise.all([a,r])}catch(t){console.error("预加载路由类型失败: ".concat(e),t)}},[])}}(),{addToHistory:M,goBack:j,goForward:_,getCurrentRoute:Y,getHistorySummary:J}=function(){let[e,t]=(0,l.useState)([]),[a,r]=(0,l.useState)(-1),c=(0,l.useCallback)(e=>{t(t=>{var l;if((null===(l=t[a])||void 0===l?void 0:l.path)===e.path)return t;let c=t.slice(0,a+1);return c.push(e),c.length>20&&c.shift(),r(c.length-1),c})},[a]),n=(0,l.useCallback)(()=>a>0?(r(e=>e-1),e[a-1]):null,[e,a]),o=(0,l.useCallback)(()=>a<e.length-1?(r(e=>e+1),e[a+1]):null,[e,a]);return{addToHistory:c,goBack:n,goForward:o,getCurrentRoute:(0,l.useCallback)(()=>e[a]||null,[e,a]),clearHistory:(0,l.useCallback)(()=>{t([]),r(-1)},[]),getHistorySummary:(0,l.useCallback)(()=>({canGoBack:a>0,canGoForward:a<e.length-1,historyLength:e.length,currentIndex:a}),[e.length,a])}}(),{startRouteLoad:H,endRouteLoad:U,getPerformanceReport:B,clearPerformanceData:G}=function(){let[e,t]=(0,l.useState)({}),a=(0,l.useCallback)(e=>performance.now(),[]);return{startRouteLoad:a,endRouteLoad:(0,l.useCallback)(function(e,a,r,l){let c=arguments.length>4&&void 0!==arguments[4]&&arguments[4],n=l?performance.now()-l:0;t(t=>{let r=t[e]||{accessCount:0,errorCount:0,totalLoadTime:0,averageLoadTime:0,lastAccessed:new Date().toISOString()},l={...r,accessCount:r.accessCount+1,errorCount:a?r.errorCount:r.errorCount+1,totalLoadTime:r.totalLoadTime+(c?0:n),averageLoadTime:c?r.averageLoadTime:(r.totalLoadTime+n)/(r.accessCount+1),lastAccessed:new Date().toISOString()};return{...t,[e]:l}})},[]),getPerformanceReport:(0,l.useCallback)(()=>{let t=Object.keys(e);if(0===t.length)return{totalRoutes:0,totalAccesses:0,totalErrors:0,averageLoadTime:0,mostAccessed:null,mostErrors:null,routeStats:{}};let a=0,r=0,l=0,c=t[0],n=t[0];return t.forEach(t=>{let o=e[t];a+=o.accessCount,r+=o.errorCount,l+=o.totalLoadTime,o.accessCount>e[c].accessCount&&(c=t),o.errorCount>e[n].errorCount&&(n=t)}),{totalRoutes:t.length,totalAccesses:a,totalErrors:r,averageLoadTime:l/a,mostAccessed:{path:c,...e[c]},mostErrors:{path:n,...e[n]},routeStats:e}},[e]),clearPerformanceData:(0,l.useCallback)(()=>{t({})},[])}}(),{preheatRoute:K,preheatRoutes:V,isRoutePreheated:W,getPreheatStatus:q,getRoutePriority:Q}=f(),{saveParams:X,getParams:Z,clearParams:$}=function(){let[e,t]=(0,l.useState)({});(0,l.useEffect)(()=>{try{let e=localStorage.getItem(C);e&&t(JSON.parse(e))}catch(e){console.error("Failed to load route params:",e)}},[]);let a=(0,l.useCallback)(e=>{try{localStorage.setItem(C,JSON.stringify(e))}catch(e){console.error("Failed to save route params:",e)}},[]);return{saveParams:(0,l.useCallback)((e,r)=>{t(t=>{let l={...t,[e]:r};return a(l),l})},[a]),getParams:(0,l.useCallback)(t=>e[t],[e]),clearParams:(0,l.useCallback)(e=>{e?t(t=>{let{[e]:r,...l}=t;return a(l),l}):(t({}),localStorage.removeItem(C))},[a])}}(),ee=(0,l.useCallback)(()=>{let e={};return m.forEach((t,a)=>{"page"===a||"limit"===a?e[a]=parseInt(t):e[a]=t}),e},[m]),et=e=>{let t=new URLSearchParams;return Object.entries(e).forEach(e=>{let[a,r]=e;null!=r&&t.append(a,String(r))}),t.toString()},ea=(0,l.useCallback)(e=>null==k||!k.validateParams||k.validateParams(e),[k]),er=(0,l.useCallback)(e=>{let t={...S,...e};if(ea(t)){let e=et(t);a.push("".concat(d).concat(e?"?".concat(e):"")),w(t),d&&X(d,t)}},[S,d,a,ea,X]);(0,l.useEffect)(()=>{let e=ee();if(Object.keys(e).length>0)w(e),d&&X(d,e);else if(d){let e=Z(d);e&&Object.keys(e).length>0&&er(e)}},[d,ee,Z,X,er]);let el=(0,l.useCallback)(()=>{d&&($(d),w({}),a.push(d))},[d,a,$]),ec=(0,l.useCallback)(async()=>{if(b){E(!0);try{let e=await (0,s.Io)("/routes/user/routes");I(e.data)}catch(e){console.error("获取用户路由失败:",e)}finally{E(!1)}}},[b]),en=(0,l.useCallback)(async e=>{if(b){L(!0);try{let t=await (0,s.Io)("/routes/family/".concat(e,"/routes"));P(t.data)}catch(e){console.error("获取家庭路由失败:",e)}finally{L(!1)}}},[b]);(0,l.useEffect)(()=>{b&&ec()},[b,ec]),(0,l.useEffect)(()=>{(null==b?void 0:b.currentFamilyId)&&en(b.currentFamilyId)},[null==b?void 0:b.currentFamilyId,en]);let eo=(0,l.useCallback)(async e=>{if(b)try{let t=await (0,s.Io)("/api/routes",{method:"POST",body:JSON.stringify(e)});return e.family_id?en(e.family_id):ec(),x("路由创建成功","success"),t.data.id}catch(e){console.error("创建路由失败:",e),x("创建路由失败","error")}},[b,en,ec,x]),es=(0,l.useCallback)(async e=>{let{id:t,data:a}=e;if(b)try{await (0,s.Io)("/api/routes/".concat(t),{method:"PUT",body:JSON.stringify(a)}),ec(),b.currentFamilyId&&en(b.currentFamilyId)}catch(e){throw console.error("更新路由失败:",e),e}},[b,ec,en]),eu=(0,l.useCallback)(async e=>{if(b)try{await (0,s.Io)("/api/routes/".concat(e),{method:"DELETE"}),ec(),b.currentFamilyId&&en(b.currentFamilyId)}catch(e){throw console.error("删除路由失败:",e),e}},[b,ec,en]),ei=(0,l.useCallback)(()=>[{key:o.wI.PUBLIC,label:"公开"},{key:o.wI.PRIVATE,label:"私有"},{key:o.wI.FAMILY,label:"家庭"},{key:o.wI.ADMIN,label:"管理员"}],[]),ed=e=>(0,i.AW)(e.type,e.permission,null==b?void 0:b.id,null==b?void 0:b.currentFamilyId);(0,l.useEffect)(()=>{k&&V([...v,...A].filter(e=>e.type===k.type&&(!k.id||e.id!==k.id)))},[k,v,A,V]);let em=(0,l.useCallback)(async(e,t)=>{let r=[...v,...A].find(t=>t.path===e);if(r&&!ed(r)){p.Am.error("无权访问该路由");return}try{let l=H(e),c=O(e);if(c){g(c),M(c),a.push("".concat(e).concat(t?et(t):"")),t&&w(t),U(e,!0,void 0,l,!0);return}if(W(e)){r&&(z(r),g(r),M(r)),a.push("".concat(e).concat(t?et(t):"")),t&&w(t),U(e,!0,void 0,l,!1);return}a.push("".concat(e).concat(t?et(t):"")),t&&w(t),r&&(await K(r),z(r),g(r),M(r)),U(e,!0,void 0,l,!1)}catch(t){console.error("导航失败:",t),U(e,!1,t),p.Am.error("导航失败")}},[a,v,A,ed,H,U,O,W,K,z,M,et]),ef=(0,l.useCallback)(async()=>{let e=j();e&&await em(e.path,e.params||{})},[j,em]),eh=(0,l.useCallback)(async()=>{let e=_();e&&await em(e.path,e.params||{})},[_,em]);(0,l.useEffect)(()=>{let e=setInterval(F,6e4);return()=>clearInterval(e)},[F]);let eC=(0,l.useCallback)(()=>{let e=B(),{preheated:t,preheating:a}=q();return{...e,cacheHitRate:0,preheatingStatus:{total:a.length+t.length,completed:t.length}}},[B,q]);return(0,r.jsx)(y.Provider,{value:{currentRoute:k,params:S,userRoutes:v,familyRoutes:A,isLoadingUserRoutes:T,isLoadingFamilyRoutes:R,fetchUserRoutes:ec,fetchFamilyRoutes:en,createRoute:eo,updateRoute:es,deleteRoute:eu,getPermissionOptions:ei,navigateToRoute:em,checkAccess:ed,handleGoBack:ef,handleGoForward:eh,getHistorySummary:J,getPerformanceReport:eC,getCacheStats:()=>({totalSize:0,itemCount:0,maxSize:0,usage:0}),getPreheatStatus:q,updateParams:er,validateParams:ea,clearPerformanceData:G,resetParams:el},children:t})}function k(e){let{children:t}=e;return(0,r.jsx)(l.Suspense,{fallback:(0,r.jsx)("div",{children:"Loading routes..."}),children:(0,r.jsx)(b,{children:t})})}function g(){let e=(0,l.useContext)(y);if(!e)throw Error("useRoute must be used within a RouteProvider");return e}},41310:function(e,t,a){a.d(t,{p:function(){return l}});var r=a(10963);function l(){return{showToast:function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"info",a={duration:3e3,style:{padding:"16px",borderRadius:"8px"}};switch(t){case"success":r.Am.success(e,a);break;case"error":r.Am.error(e,a);break;case"warning":(0,r.Am)(e,{...a,icon:"⚠️"});break;default:(0,r.Am)(e,{...a,icon:"ℹ️"})}}}}}}]);