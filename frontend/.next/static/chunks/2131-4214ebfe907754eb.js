"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[2131],{96770:function(e,t,n){n.r(t),n.d(t,{ToastProvider:function(){return u},useToast:function(){return c}});var r=n(3827),o=n(64090),a=n(10963);let s=(0,o.createContext)(void 0);function c(){let e=(0,o.useContext)(s);if(!e)throw Error("useToast must be used within a ToastProvider");return e}function u(e){let{children:t}=e;return(0,r.jsxs)(s.Provider,{value:{showToast:function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"info",n={duration:3e3,style:{padding:"16px",borderRadius:"8px"}};switch(t){case"success":a.Am.success(e,n);break;case"error":a.Am.error(e,n);break;case"warning":(0,a.Am)(e,{...n,icon:"⚠️"});break;default:(0,a.Am)(e,{...n,icon:"ℹ️"})}}},children:[t,(0,r.jsx)(a.x7,{position:"top-center"})]})}},26632:function(e,t,n){n.d(t,{AW:function(){return a},Kz:function(){return o},P8:function(){return s}});var r=n(77785);let o={[r.Yt.DASHBOARD]:{component:()=>Promise.all([n.e(7674),n.e(6034),n.e(9390),n.e(9689),n.e(7945),n.e(7530),n.e(9178),n.e(3614),n.e(5784),n.e(7385),n.e(6288),n.e(224),n.e(4187),n.e(1945),n.e(8704),n.e(414),n.e(4322),n.e(568),n.e(5961),n.e(4642),n.e(4788),n.e(6373),n.e(8792),n.e(5769),n.e(1581),n.e(6573),n.e(9430),n.e(3135),n.e(2616),n.e(5626),n.e(3530),n.e(7456),n.e(2949),n.e(7923),n.e(8026)]).then(n.bind(n,27923)).then(e=>e.default),permission:r.wI.PRIVATE,layout:()=>Promise.all([n.e(9390),n.e(9178),n.e(3614),n.e(7108)]).then(n.bind(n,17108)).then(e=>e.default)},[r.Yt.TRANSACTIONS]:{component:()=>Promise.all([n.e(6034),n.e(9390),n.e(9689),n.e(7945),n.e(7530),n.e(9178),n.e(3614),n.e(5784),n.e(7385),n.e(6288),n.e(224),n.e(4187),n.e(1945),n.e(8704),n.e(414),n.e(4322),n.e(568),n.e(5961),n.e(4788),n.e(1581),n.e(2616),n.e(3121),n.e(7456),n.e(1731)]).then(n.bind(n,47646)).then(e=>e.default),permission:r.wI.FAMILY,layout:()=>Promise.all([n.e(6034),n.e(9390),n.e(9689),n.e(7945),n.e(7530),n.e(9178),n.e(3614),n.e(6288),n.e(3121),n.e(3345)]).then(n.bind(n,33345)).then(e=>e.default)},[r.Yt.STATISTICS]:{component:()=>Promise.all([n.e(7674),n.e(6034),n.e(9390),n.e(9689),n.e(7945),n.e(7530),n.e(9178),n.e(3614),n.e(5784),n.e(7385),n.e(6288),n.e(224),n.e(4187),n.e(1945),n.e(8704),n.e(414),n.e(4322),n.e(568),n.e(5961),n.e(4642),n.e(4788),n.e(6373),n.e(8792),n.e(5769),n.e(1581),n.e(6573),n.e(3121),n.e(7456),n.e(2949),n.e(7641)]).then(n.bind(n,87641)).then(e=>e.default),permission:r.wI.FAMILY,layout:()=>Promise.all([n.e(6034),n.e(9390),n.e(9689),n.e(7945),n.e(7530),n.e(9178),n.e(3614),n.e(6288),n.e(3121),n.e(8891)]).then(n.bind(n,18891)).then(e=>e.default)},[r.Yt.SETTINGS]:{component:()=>Promise.all([n.e(6034),n.e(9390),n.e(9689),n.e(7945),n.e(1077)]).then(n.bind(n,1077)).then(e=>e.default),permission:r.wI.PRIVATE,layout:()=>Promise.all([n.e(6034),n.e(9390),n.e(9689),n.e(7945),n.e(9178),n.e(3614),n.e(8792),n.e(1207)]).then(n.bind(n,31207)).then(e=>e.default)},[r.Yt.CUSTOM]:{component:()=>Promise.all([n.e(6034),n.e(9390),n.e(9689),n.e(7945),n.e(9178),n.e(3614),n.e(6288),n.e(3121),n.e(7386)]).then(n.bind(n,7386)).then(e=>e.default),permission:r.wI.PRIVATE,layout:()=>Promise.all([n.e(6034),n.e(9390),n.e(9689),n.e(7945),n.e(7530),n.e(9178),n.e(3614),n.e(510)]).then(n.bind(n,20510)).then(e=>e.default)}};function a(e,t,n,a){switch(o[e],t){case r.wI.PUBLIC:return!0;case r.wI.PRIVATE:return!!n;case r.wI.FAMILY:case r.wI.ADMIN:return!!n&&!!a;default:return!1}}async function s(e,t){let n=o[t];if(!n)throw Error("未找到路由类型 ".concat(t," 对应的组件"));try{let e=await n.component(),t=n.layout?await n.layout():null;return{Component:e,Layout:t,permission:n.permission}}catch(e){throw console.error("加载路由组件失败: ".concat(e)),e}}},52131:function(e,t,n){n.r(t),n.d(t,{AuthProvider:function(){return w},useAuth:function(){return p}});var r=n(3827),o=n(64090),a=n(47907),s=n(96770),c=n(58222),u=n(94564),i=n(37963),l=n(77785),d=n(26632);let f=async e=>{let t=await (0,c.Io)("/auth/login",{method:"POST",body:JSON.stringify(e)});return console.log("ssss",t),t.data},h=async e=>(await (0,c.Io)("/auth/register",{method:"POST",body:JSON.stringify(e)})).data,m=async e=>(await (0,c.Io)("/auth/verify-guest",{method:"POST",body:JSON.stringify({password:e})})).data,y=async e=>(await (0,c.Io)("/user/settings",{method:"PATCH",body:JSON.stringify(e)})).data,g=(0,o.createContext)(void 0);function w(e){let{children:t}=e,[n,c]=(0,o.useState)(null),[w,p]=(0,o.useState)(!1),[I,S]=(0,o.useState)(!1),T=(0,a.useRouter)(),{showToast:P}=(0,s.useToast)(),b=e=>{try{let t=(0,i.o)(e),n=Date.now()/1e3;if(t.exp&&t.exp<n)return(0,u.gy)(),localStorage.removeItem("isGuest"),null;return{id:t.id,username:t.username,email:t.email,role:t.role,privacy_mode:t.privacy_mode,default_route:t.default_route,permissions:t.permissions}}catch(e){return console.error("解析 token 失败:",e),(0,u.gy)(),localStorage.removeItem("isGuest"),null}},v=async e=>{if(!e||!e.default_route){T.push("/dashboard");return}try{let t=e.default_route,n=t.split("/")[1];if(!(0,d.AW)(n,l.wI.PRIVATE,"string"==typeof e.id?parseInt(e.id,10):e.id,e.currentFamilyId?"string"==typeof e.currentFamilyId?parseInt(e.currentFamilyId,10):e.currentFamilyId:void 0)){console.warn("用户无权访问默认路由，重定向到仪表盘"),T.push("/dashboard");return}await (0,d.P8)(t,n),T.push(t)}catch(e){console.error("路由导航失败:",e),T.push("/dashboard")}};(0,o.useEffect)(()=>{let e=(0,u.LP)(),t="true"===localStorage.getItem("isGuest"),n=window.location.pathname,r=n.startsWith("/auth/"),o="/"===n||"/about"===n;if(e){let n=b(e);n?(c(n),p(t),r&&v(n)):r||o||T.push("/auth/login")}else r||o||T.push("/auth/login")},[T]);let A=async(e,t)=>{try{let{token:n,user:r}=await f({email:e,password:t});(0,u.o4)(n),c(r),p(!1),localStorage.setItem("isGuest","false"),P("登录成功","success"),v(r)}catch(e){throw P("登录失败","error"),e}},E=async e=>{try{let{token:t,user:n}=await h(e);(0,u.o4)(t),c(n),p(!1),localStorage.setItem("isGuest","false"),P("注册成功","success"),v(n)}catch(e){throw P("注册失败","error"),e}},O=async e=>{try{await m(e),p(!0),localStorage.setItem("isGuest","true")}catch(e){throw e}},N=async e=>{try{let t=await y(e);return c(t),t}catch(e){throw e instanceof Error?P(e.message,"error"):P("更新设置失败","error"),e}};return(0,r.jsx)(g.Provider,{value:{user:n,isGuest:w,isLoading:I,setUser:c,updateUser:e=>{c(e)},updateSettings:N,login:A,register:E,logout:()=>{(0,u.gy)(),localStorage.removeItem("isGuest"),c(null),p(!1),T.push("/auth/login")},enterGuestMode:O,exitGuestMode:()=>{p(!1),localStorage.removeItem("isGuest")},handleUnauthorized:()=>{(0,u.gy)(),localStorage.removeItem("isGuest"),localStorage.removeItem("currentFamilyId"),c(null),p(!1),"/auth/login"!==window.location.pathname&&(P("登录已过期，请重新登录","error"),T.push("/auth/login"))}},children:t})}function p(){let e=(0,o.useContext)(g);if(void 0===e)throw Error("useAuth must be used within an AuthProvider");return e}},58222:function(e,t,n){n.d(t,{AW:function(){return O},Cp:function(){return L},Ds:function(){return m},HL:function(){return p},Hb:function(){return u},Io:function(){return f},KX:function(){return g},M$:function(){return G},Ml:function(){return x},Nq:function(){return N},Ny:function(){return I},P9:function(){return S},R5:function(){return C},_c:function(){return T},dx:function(){return y},fM:function(){return E},fq:function(){return b},h8:function(){return D},hQ:function(){return i},le:function(){return w},ot:function(){return P},qW:function(){return v},rr:function(){return A},we:function(){return h}});var r=n(77785),o=n(94564);let a=n(49079).env.NEXT_PUBLIC_API_URL||"http://localhost:3001/api",s=null,c=null;function u(e){s=e}function i(e){c=e}function l(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"error";c?c(e,t):console["error"===t?"error":"warning"===t?"warn":"log"](e)}let d={400:e=>{console.warn("请求参数错误: ".concat(e)),l("请求参数错误: ".concat(e),"warning")},401:e=>{(0,o.gy)(),localStorage.removeItem("isGuest"),localStorage.removeItem("currentFamilyId"),s?s():"/auth/login"!==window.location.pathname&&(l("登录已过期，请重新登录"+window.location.pathname,"error"),window.location.href="/auth/login")},403:e=>{console.warn("无权访问: ".concat(e)),l("无权访问: ".concat(e),"error")},404:e=>{console.warn("资源不存在: ".concat(e)),l("资源不存在: ".concat(e),"warning")},422:e=>{console.warn("数据验证失败: ".concat(e)),l("数据验证失败: ".concat(e),"warning")},429:e=>{console.warn("请求过多，请稍后再试: ".concat(e)),l("请求过多，请稍后再试","warning")},500:e=>{console.error("服务器错误: ".concat(e)),l("服务器内部错误，请稍后再试: ".concat(e),"error")},502:e=>{console.error("网关错误: ".concat(e)),l("服务器网关错误，请稍后再试","error")},503:e=>{console.error("服务不可用: ".concat(e)),l("服务暂时不可用，请稍后再试","error")},504:e=>{console.error("网关超时: ".concat(e)),l("请求超时，请检查网络连接后重试","error")}};async function f(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n="".concat(a).concat(e),s=(0,o.LP)(),c={"Content-Type":"application/json",...s?{Authorization:"Bearer ".concat(s)}:{}};try{let e=await fetch(n,{...t,headers:{...c,...t.headers}}),o=await e.json();if(console.log("sssssss",o),!e.ok){let t=d[e.status];throw t&&t(o.message||"请求失败"),new r.Hx(e.status,o.message||"请求失败")}return{data:o,message:o.message,status:e.status}}catch(e){if(e instanceof r.Hx)throw e;throw new r.Hx(500,e instanceof Error?e.message:"网络错误")}}let h=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"请求失败";if(e instanceof r.Hx)switch(e.status){case 400:return"请求参数错误: ".concat(e.message);case 403:return"无权访问: ".concat(e.message);case 404:return"资源不存在: ".concat(e.message);case 429:return"请求过于频繁，请稍后再试";case 500:case 502:case 503:return"服务器错误: ".concat(e.message);default:return e.message||t}return(null==e?void 0:e.message)||t};async function m(e){return(await f("/routes/predictions?user_id=".concat(e),{method:"GET"})).data}async function y(e){return(await f("/routes/".concat(e,"/optimization"),{method:"GET"})).data}async function g(e){let t=new URLSearchParams;e.startDate&&t.append("startDate",e.startDate),e.endDate&&t.append("endDate",e.endDate),e.routeIds&&e.routeIds.length>0&&e.routeIds.forEach(e=>t.append("routeIds[]",e.toString()));let n="".concat(a,"/routes/export?").concat(t.toString(),"&format=").concat(e.format),s=(0,o.LP)(),c=await fetch(n,{method:"GET",headers:{...s?{Authorization:"Bearer ".concat(s)}:{}}});if(!c.ok){let e=await c.json();throw new r.Hx(c.status,e.message||"导出失败")}return await c.blob()}async function w(e){let t=new URLSearchParams;return t.append("type",e.type),e.startDate&&t.append("startDate",e.startDate),e.endDate&&t.append("endDate",e.endDate),e.routeIds&&e.routeIds.length>0&&e.routeIds.forEach(e=>t.append("routeIds[]",e.toString())),(await f("/routes/visualization?".concat(t.toString()),{method:"GET"})).data}async function p(e){return f("/categories",{method:"POST",body:JSON.stringify(e)})}async function I(e,t){return f("/categories/".concat(e),{method:"PUT",body:JSON.stringify(t)})}async function S(e){return f("/categories/".concat(e),{method:"DELETE"})}async function T(){return f("/routes")}async function P(e){return f("/routes",{method:"POST",body:JSON.stringify(e)})}async function b(e,t){return f("/routes/".concat(e),{method:"PUT",body:JSON.stringify(t)})}async function v(e){return f("/routes/".concat(e),{method:"DELETE"})}async function A(e){return f("/routes/".concat(e,"/toggle"),{method:"POST"})}async function E(e){return f("/routes/".concat(e,"/stats"))}async function O(){return f("/users")}async function N(e,t){return f("/users/".concat(e),{method:"PUT",body:JSON.stringify(t)})}async function D(e){return f("/users/".concat(e),{method:"DELETE"})}async function x(e){return f("/users/".concat(e,"/freeze"),{method:"POST"})}async function C(e){return f("/users/".concat(e,"/unfreeze"),{method:"POST"})}async function L(e){return f("/auth/change-password",{method:"POST",body:JSON.stringify(e)})}async function G(e){return f("/users/privacy",{method:"PUT",body:JSON.stringify(e)})}},77785:function(e,t,n){var r,o,a,s;n.d(t,{Hx:function(){return c},Yt:function(){return r},wI:function(){return o}});class c extends Error{constructor(e,t){super(t),this.status=e,this.name="APIError"}}(a=r||(r={})).DASHBOARD="dashboard",a.TRANSACTIONS="transactions",a.STATISTICS="statistics",a.SETTINGS="settings",a.CUSTOM="custom",(s=o||(o={})).PUBLIC="public",s.PRIVATE="private",s.FAMILY="family",s.ADMIN="admin"},94564:function(e,t,n){function r(){return localStorage.getItem("token")}function o(e){localStorage.setItem("token",e)}function a(){localStorage.removeItem("token")}n.d(t,{LP:function(){return r},gy:function(){return a},o4:function(){return o}})}}]);